{% extends "base.html" %}
{% set active_page = "live_tracking" %}

{% block title %}Live Tracking - SierraWings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h3 fw-bold text-primary mb-1">
                        <i class="fas fa-map-marked-alt me-2"></i>Live Mission Tracking
                    </h2>
                    <p class="text-muted mb-0">Real-time drone movement and delivery status monitoring</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshTracking()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                    <button class="btn btn-outline-success" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                        <i class="fas fa-play me-1"></i> Auto Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map Section -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-globe-americas me-2"></i>Live Map View
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="liveTrackingMap" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Mission List Section -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-alt me-2"></i>Active Missions
                    </h5>
                    <span class="badge bg-light text-dark" id="activeMissionCount">{{ missions|length }}</span>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div id="missionsList">
                        {% if missions %}
                            {% for mission in missions %}
                            <div class="mission-item border-bottom p-3" data-mission-id="{{ mission.id }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold text-primary mb-1">Mission #{{ mission.id }}</h6>
                                    <span class="badge bg-{{ 'warning' if mission.status == 'accepted' else 'info' if mission.status == 'in_flight' else 'success' }}">
                                        {{ mission.status.title() }}
                                    </span>
                                </div>
                                <div class="small text-muted mb-2">
                                    <div><i class="fas fa-user me-1"></i> {{ mission.user.full_name }}</div>
                                    <div><i class="fas fa-box me-1"></i> {{ mission.payload_type }} ({{ mission.payload_weight }}kg)</div>
                                    <div><i class="fas fa-clock me-1"></i> {{ mission.created_at.strftime('%H:%M') }}</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="centerOnMission({{ mission.id }})">
                                        <i class="fas fa-crosshairs me-1"></i> Track
                                    </button>
                                    {% if mission.status == 'accepted' %}
                                    <button class="btn btn-success btn-sm" onclick="startMission({{ mission.id }})">
                                        <i class="fas fa-play me-1"></i> Start
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-drone fa-3x mb-3"></i>
                            <p>No active missions at the moment</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Details Modal -->
    <div class="modal fade" id="missionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Mission Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="missionDetailsContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let map, markers = {}, polylines = {}, autoRefreshInterval;
let isAutoRefreshActive = false;

// Initialize map
function initializeMap() {
    // Center map on Sierra Leone
    map = L.map('liveTrackingMap').setView([8.460555, -11.779889], 8);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Load initial missions
    loadActiveMissions();
}

// Load and display active missions
async function loadActiveMissions() {
    try {
        const response = await fetch('/api/active-missions');
        const missions = await response.json();
        
        // Clear existing markers
        Object.values(markers).forEach(marker => map.removeLayer(marker));
        Object.values(polylines).forEach(polyline => map.removeLayer(polyline));
        markers = {};
        polylines = {};
        
        // Add markers for each mission
        missions.forEach(mission => {
            addMissionMarkers(mission);
        });
        
        // Update mission count
        document.getElementById('activeMissionCount').textContent = missions.length;
        
    } catch (error) {
        console.error('Failed to load missions:', error);
        showSierraWingsNotification('Failed to load mission data', 'error');
    }
}

// Add markers for a mission
function addMissionMarkers(mission) {
    const missionId = mission.id;
    
    // Pickup marker (red)
    if (mission.pickup_lat && mission.pickup_lon) {
        const pickupMarker = L.marker([mission.pickup_lat, mission.pickup_lon], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-content bg-danger text-white">
                         <i class="fas fa-hospital"></i>
                       </div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);
        
        pickupMarker.bindPopup(`
            <div class="text-center">
                <h6>Pickup Location</h6>
                <p class="mb-1"><strong>Mission #${mission.id}</strong></p>
                <p class="mb-1">${mission.payload_type}</p>
                <p class="mb-0">${mission.pickup_address}</p>
            </div>
        `);
        
        markers[`pickup_${missionId}`] = pickupMarker;
    }
    
    // Delivery marker (blue)
    if (mission.delivery_lat && mission.delivery_lon) {
        const deliveryMarker = L.marker([mission.delivery_lat, mission.delivery_lon], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-content bg-primary text-white">
                         <i class="fas fa-map-marker-alt"></i>
                       </div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);
        
        deliveryMarker.bindPopup(`
            <div class="text-center">
                <h6>Delivery Location</h6>
                <p class="mb-1"><strong>Mission #${mission.id}</strong></p>
                <p class="mb-1">Patient: ${mission.user_name}</p>
                <p class="mb-0">${mission.delivery_address}</p>
            </div>
        `);
        
        markers[`delivery_${missionId}`] = deliveryMarker;
    }
    
    // Load drone position if in flight
    if (mission.status === 'in_flight') {
        loadDronePosition(mission.id);
    }
}

// Load drone position for a mission
async function loadDronePosition(missionId) {
    try {
        const response = await fetch(`/api/mission/${missionId}/drone-position`);
        if (response.ok) {
            const droneData = await response.json();
            
            // Add drone marker (green)
            const droneMarker = L.marker([droneData.lat, droneData.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="marker-content bg-success text-white drone-marker" 
                             style="transform: rotate(${droneData.heading || 0}deg)">
                             <i class="fas fa-drone"></i>
                           </div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 17.5]
                })
            }).addTo(map);
            
            droneMarker.bindPopup(`
                <div class="text-center">
                    <h6>${droneData.drone_name}</h6>
                    <p class="mb-1"><strong>Mission #${missionId}</strong></p>
                    <p class="mb-1">Altitude: ${droneData.altitude}m</p>
                    <p class="mb-1">Speed: ${droneData.speed}m/s</p>
                    <p class="mb-1">Battery: ${droneData.battery_level}%</p>
                    <p class="mb-0">Signal: ${droneData.signal_strength}%</p>
                </div>
            `);
            
            markers[`drone_${missionId}`] = droneMarker;
            
            // Load route tracking
            loadMissionRoute(missionId);
        }
    } catch (error) {
        console.error('Failed to load drone position:', error);
    }
}

// Load mission route
async function loadMissionRoute(missionId) {
    try {
        const response = await fetch(`/api/mission/${missionId}/tracking`);
        if (response.ok) {
            const trackingData = await response.json();
            
            if (trackingData.route_points && trackingData.route_points.length > 1) {
                const polyline = L.polyline(trackingData.route_points, {
                    color: '#28a745',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 10'
                }).addTo(map);
                
                polylines[`route_${missionId}`] = polyline;
            }
        }
    } catch (error) {
        console.error('Failed to load mission route:', error);
    }
}

// Center map on specific mission
function centerOnMission(missionId) {
    const pickupMarker = markers[`pickup_${missionId}`];
    const deliveryMarker = markers[`delivery_${missionId}`];
    const droneMarker = markers[`drone_${missionId}`];
    
    const bounds = L.latLngBounds([]);
    
    if (pickupMarker) bounds.extend(pickupMarker.getLatLng());
    if (deliveryMarker) bounds.extend(deliveryMarker.getLatLng());
    if (droneMarker) bounds.extend(droneMarker.getLatLng());
    
    if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: [20, 20] });
    }
}

// Start mission
async function startMission(missionId) {
    try {
        const response = await fetch(`/api/missions/${missionId}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            showSierraWingsNotification(`Mission #${missionId} started successfully!`, 'success');
            setTimeout(refreshTracking, 1000);
        } else {
            throw new Error('Failed to start mission');
        }
    } catch (error) {
        console.error('Failed to start mission:', error);
        showSierraWingsNotification('Failed to start mission', 'error');
    }
}

// Refresh tracking data
function refreshTracking() {
    loadActiveMissions();
    showSierraWingsNotification('Tracking data refreshed', 'info', 2000);
}

// Toggle auto refresh
function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (isAutoRefreshActive) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshActive = false;
        btn.innerHTML = '<i class="fas fa-play me-1"></i> Auto Refresh';
        btn.className = 'btn btn-outline-success';
    } else {
        autoRefreshInterval = setInterval(refreshTracking, 10000); // Every 10 seconds
        isAutoRefreshActive = true;
        btn.innerHTML = '<i class="fas fa-pause me-1"></i> Auto Refresh';
        btn.className = 'btn btn-outline-warning';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
});
</script>

<style>
.custom-marker .marker-content {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.drone-marker {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1) rotate(var(--rotation, 0deg)); }
    50% { transform: scale(1.1) rotate(var(--rotation, 0deg)); }
    100% { transform: scale(1) rotate(var(--rotation, 0deg)); }
}

.mission-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}

.mission-item:last-child {
    border-bottom: none !important;
}
</style>
{% endblock %}