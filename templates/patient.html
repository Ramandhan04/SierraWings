{% extends "base.html" %}

{% block title %}Patient Dashboard - SierraWings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-heartbeat text-primary me-2"></i>
                        Welcome, {{ current_user.first_name }}
                    </h1>
                    <p class="text-muted mb-0">Emergency Medical Drone Delivery Dashboard</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <a href="{{ url_for('auth.settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-user-cog me-2"></i>Profile
                    </a>
                    <a href="{{ url_for('patient.find_clinics') }}" class="btn btn-outline-primary">
                        <i class="fas fa-hospital me-2"></i>Find Medical Facilities
                    </a>
                    <button class="btn btn-danger emergency-panic-btn" id="emergencyBtn">
                        <i class="fas fa-exclamation-triangle me-2"></i>EMERGENCY
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestDeliveryModal">
                        <i class="fas fa-plus me-2"></i>Request Delivery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Card Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger shadow-lg">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                        <div>
                            <h4 class="card-title mb-0">EMERGENCY MEDICAL DELIVERY</h4>
                            <p class="mb-0 small">24/7 Critical Care • Call 117 for immediate assistance</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="text-dark mb-2">
                                <strong>Critical medical supplies delivered within 8-12 minutes</strong>
                            </p>
                            <p class="text-muted mb-0">
                                For life-threatening emergencies requiring immediate medical supply delivery.
                                Our emergency drones are equipped with temperature-controlled compartments and priority flight paths.
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-danger btn-lg emergency-card-btn" id="emergencyCardBtn">
                                <i class="fas fa-ambulance me-2"></i>REQUEST EMERGENCY DRONE
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>Secure • Encrypted • HIPAA Compliant
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_missions }}</h3>
                    <p>Total Requests</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ pending_missions }}</h3>
                    <p>Pending</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-info">
                <div class="stat-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ in_flight_missions }}</h3>
                    <p>In Flight</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ completed_missions }}</h3>
                    <p>Completed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>My Delivery Requests
                    </h5>
                </div>
                <div class="card-body">
                    {% if missions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Payload</th>
                                        <th>Pickup Address</th>
                                        <th>Delivery Address</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mission in missions %}
                                    <tr>
                                        <td><strong>#{{ mission.id }}</strong></td>
                                        <td>
                                            {{ mission.payload_type }}
                                            {% if mission.payload_weight %}
                                                <br><small class="text-muted">{{ mission.payload_weight }}kg</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ mission.pickup_address[:50] }}{% if mission.pickup_address|length > 50 %}...{% endif %}</td>
                                        <td>{{ mission.delivery_address[:50] }}{% if mission.delivery_address|length > 50 %}...{% endif %}</td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if mission.priority == 'emergency' else 'warning' if mission.priority == 'high' else 'primary' }}">
                                                {{ mission.priority|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 
                                                'secondary' if mission.status == 'pending' else
                                                'info' if mission.status == 'accepted' else
                                                'primary' if mission.status == 'in_flight' else
                                                'success' if mission.status == 'completed' else
                                                'danger' if mission.status in ['cancelled', 'rejected'] else
                                                'secondary'
                                            }}">
                                                {{ mission.status|replace('_', ' ')|title }}
                                            </span>
                                        </td>
                                        <td>{{ mission.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if mission.status == 'in_flight' %}
                                                    <button class="btn btn-sm btn-primary" onclick="trackMission({{ mission.id }})">
                                                        <i class="fas fa-map-marker-alt"></i> Track
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewMissionDetails({{ mission.id }})">
                                                    <i class="fas fa-eye"></i> Details
                                                </button>
                                                {% if mission.status in ['pending', 'accepted'] %}
                                                    <form method="POST" action="{{ url_for('patient.cancel_mission', mission_id=mission.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to cancel this mission?')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-times"></i> Cancel
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5>No delivery requests yet</h5>
                            <p class="text-muted">Click "Request Delivery" to create your first delivery request.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestDeliveryModal">
                                <i class="fas fa-plus me-2"></i>Request Your First Delivery
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Delivery Modal -->
<div class="modal fade" id="requestDeliveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Request Medical Delivery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('patient.request_delivery') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payload_type" class="form-label">Payload Type</label>
                                <select class="form-select" id="payload_type" name="payload_type" required>
                                    <option value="">Select payload type</option>
                                    <option value="Medication">Medication</option>
                                    <option value="Medical Supplies">Medical Supplies</option>
                                    <option value="Blood Sample">Blood Sample</option>
                                    <option value="Test Results">Test Results</option>
                                    <option value="Emergency Kit">Emergency Kit</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payload_weight" class="form-label">Weight (kg) - Optional</label>
                                <input type="number" class="form-control" id="payload_weight" name="payload_weight" min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="pickup_address" class="form-label">Pickup Address</label>
                        <textarea class="form-control" id="pickup_address" name="pickup_address" rows="2" required placeholder="Enter the full pickup address"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="delivery_address" class="form-label">Delivery Address</label>
                        <textarea class="form-control" id="delivery_address" name="delivery_address" rows="2" required placeholder="Enter the full delivery address"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority Level</label>
                        <select class="form-select" id="priority" name="priority" required>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="special_instructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="special_instructions" name="special_instructions" rows="3" placeholder="Any special handling instructions or notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Track Mission Modal -->
<div class="modal fade" id="trackMissionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map-marker-alt me-2"></i>Live Drone Tracking
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="trackingMap" style="height: 500px;"></div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="telemetry-widget">
                            <i class="fas fa-battery-three-quarters text-success"></i>
                            <span>Battery: <span id="batteryLevel">--</span>%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="telemetry-widget">
                            <i class="fas fa-tachometer-alt text-primary"></i>
                            <span>Speed: <span id="droneSpeed">--</span> m/s</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="telemetry-widget">
                            <i class="fas fa-mountain text-info"></i>
                            <span>Altitude: <span id="droneAltitude">--</span> m</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="telemetry-widget">
                            <i class="fas fa-signal text-success"></i>
                            <span>Signal: <span id="signalStrength">--</span>%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let trackingMap = null;
let trackingInterval = null;
let currentMissionId = null;
let droneMarker = null;
let flightPath = null;

// Sierra Wings notification system
function showSierraWingsNotification(message, type = 'info', duration = 5000) {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.sierrawings-notification');
    existingNotifications.forEach(n => n.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `sierrawings-notification alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'danger' ? 'exclamation-triangle' : 
                 type === 'warning' ? 'exclamation-circle' : 'info-circle';
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${icon} me-2"></i>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after duration
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
}

// Emergency functionality
function showEmergencyModal() {
    // Remove any existing emergency modal
    const existingModal = document.getElementById('emergencyModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create emergency modal HTML
    const modalHTML = `
        <div class="modal fade" id="emergencyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content border-danger">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>EMERGENCY REQUEST
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-heartbeat me-2"></i>
                            <strong>Emergency medical delivery request initiated!</strong>
                        </div>
                        <form id="emergencyForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Emergency Type <span class="text-danger">*</span></label>
                                    <select class="form-select" name="emergency_type" id="emergencyType" required onchange="updateEmergencyCost()">
                                        <option value="">Select emergency type</option>
                                        <option value="cardiac" data-base-cost="45">Cardiac Emergency (45 NLE)</option>
                                        <option value="respiratory" data-base-cost="40">Respiratory Emergency (40 NLE)</option>
                                        <option value="trauma" data-base-cost="50">Trauma/Injury (50 NLE)</option>
                                        <option value="medication" data-base-cost="35">Critical Medication (35 NLE)</option>
                                        <option value="blood" data-base-cost="60">Blood/Plasma (60 NLE)</option>
                                        <option value="organ" data-base-cost="100">Organ Transport (100 NLE)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Quantity/Weight</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" onclick="adjustQuantity(-1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="form-control text-center" id="emergencyQuantity" value="1" min="1" max="10" onchange="updateEmergencyCost()">
                                        <button class="btn btn-outline-secondary" type="button" onclick="adjustQuantity(1)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    <small class="text-muted">Maximum 10kg per delivery</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Emergency Details <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="emergency_details" rows="3" 
                                          placeholder="Describe the emergency situation..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Delivery Address <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="delivery_address" rows="2" 
                                          placeholder="Emergency delivery location..." required></textarea>
                            </div>
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Emergency Delivery Cost:</strong>
                                        <div class="mt-1">
                                            <small class="text-muted">Base Cost + Weight-based pricing + Emergency surcharge</small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <h4 class="mb-0 text-primary" id="emergencyTotalCost">0 NLE</h4>
                                        <small class="text-muted">Total Cost</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="submitEmergencyRequest()">
                            <i class="fas fa-ambulance me-2"></i>DISPATCH EMERGENCY DRONE
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('emergencyModal'));
    modal.show();
}

function submitEmergencyRequest() {
    const form = document.getElementById('emergencyForm');
    const formData = new FormData(form);
    
    // Add quantity and cost data
    const quantity = document.getElementById('emergencyQuantity').value;
    const totalCost = document.getElementById('emergencyTotalCost').textContent.replace(' NLE', '');
    
    formData.append('quantity', quantity);
    formData.append('total_cost', totalCost);
    
    // Validate form
    if (!formData.get('emergency_type') || !formData.get('emergency_details') || !formData.get('delivery_address')) {
        showSierraWingsNotification('Please fill in all required fields.', 'warning');
        return;
    }
    
    // Submit emergency request
    fetch('/patient/emergency-request', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('emergencyModal'));
        modal.hide();
        
        if (data.success) {
            showSierraWingsNotification(`Emergency drone dispatch initiated! Cost: ${totalCost} NLE. All clinics notified. ETA: 8-12 minutes`, 'success', 8000);
            setTimeout(() => location.reload(), 2000);
        } else {
            showSierraWingsNotification('Emergency request failed. Please call 117 immediately.', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const modal = bootstrap.Modal.getInstance(document.getElementById('emergencyModal'));
        modal.hide();
        showSierraWingsNotification('Emergency request failed. Please call 117 immediately.', 'danger');
    });
}

// Emergency cost calculation functions
function updateEmergencyCost() {
    const typeSelect = document.getElementById('emergencyType');
    const quantityInput = document.getElementById('emergencyQuantity');
    const costDisplay = document.getElementById('emergencyTotalCost');
    
    if (!typeSelect.value) {
        costDisplay.textContent = '0 NLE';
        return;
    }
    
    const selectedOption = typeSelect.selectedOptions[0];
    const baseCost = parseFloat(selectedOption.dataset.baseCost || 30);
    const quantity = parseFloat(quantityInput.value || 1);
    
    // Calculate total cost: base cost + (quantity * weight multiplier) + emergency surcharge
    const weightMultiplier = 5; // 5 NLE per kg
    const emergencySurcharge = 15; // Emergency surcharge
    
    const totalCost = baseCost + (quantity * weightMultiplier) + emergencySurcharge;
    
    costDisplay.textContent = `${totalCost.toFixed(0)} NLE`;
}

function adjustQuantity(change) {
    const quantityInput = document.getElementById('emergencyQuantity');
    let currentValue = parseInt(quantityInput.value) || 1;
    let newValue = currentValue + change;
    
    // Ensure value stays within bounds
    if (newValue < 1) newValue = 1;
    if (newValue > 10) newValue = 10;
    
    quantityInput.value = newValue;
    updateEmergencyCost();
}



function trackMission(missionId) {
    currentMissionId = missionId;
    $('#trackMissionModal').modal('show');
    
    // Initialize map when modal is shown
    $('#trackMissionModal').on('shown.bs.modal', function() {
        if (!trackingMap) {
            initTrackingMap();
        }
        startTracking();
    });
    
    // Clean up when modal is hidden
    $('#trackMissionModal').on('hidden.bs.modal', function() {
        stopTracking();
    });
}

function initTrackingMap() {
    trackingMap = L.map('trackingMap').setView([37.7749, -122.4194], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(trackingMap);
    
    // Add drone marker
    const droneIcon = L.divIcon({
        className: 'drone-marker',
        html: '<i class="fas fa-helicopter" style="color: #0d6efd; font-size: 20px;"></i>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });
    
    droneMarker = L.marker([37.7749, -122.4194], {icon: droneIcon}).addTo(trackingMap);
    
    // Initialize flight path
    flightPath = L.polyline([], {color: 'blue', weight: 3, opacity: 0.7}).addTo(trackingMap);
}

function startTracking() {
    updateTelemetry();
    trackingInterval = setInterval(updateTelemetry, 2000); // Update every 2 seconds
}

function stopTracking() {
    if (trackingInterval) {
        clearInterval(trackingInterval);
        trackingInterval = null;
    }
}

function updateTelemetry() {
    if (!currentMissionId) return;
    
    fetch(`/api/telemetry?mission_id=${currentMissionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                const latest = data[0];
                
                // Update map
                const newPos = [latest.latitude, latest.longitude];
                droneMarker.setLatLng(newPos);
                trackingMap.setView(newPos, 14);
                
                // Update flight path
                const pathCoords = data.slice(0, 10).map(t => [t.latitude, t.longitude]).reverse();
                flightPath.setLatLngs(pathCoords);
                
                // Update telemetry widgets
                document.getElementById('batteryLevel').textContent = latest.battery_level || '--';
                document.getElementById('droneSpeed').textContent = latest.speed ? latest.speed.toFixed(1) : '--';
                document.getElementById('droneAltitude').textContent = latest.altitude ? latest.altitude.toFixed(0) : '--';
                document.getElementById('signalStrength').textContent = latest.signal_strength || '--';
            }
        })
        .catch(error => {
            console.error('Error fetching telemetry:', error);
        });
    
    // Simulate telemetry data generation
    // Telemetry data retrieved from authentic drone sensors only
}

function viewMissionDetails(missionId) {
    window.location.href = `/patient/mission/${missionId}/details`;
}

// Initialize emergency buttons when page loads
document.addEventListener('DOMContentLoaded', function() {
    const emergencyBtn = document.getElementById('emergencyBtn');
    const emergencyCardBtn = document.getElementById('emergencyCardBtn');
    
    function handleEmergencyClick(e) {
        e.preventDefault();
        if (confirm('This will trigger an EMERGENCY medical drone delivery request. Are you sure?')) {
            showEmergencyModal();
        }
    }
    
    if (emergencyBtn) {
        emergencyBtn.addEventListener('click', handleEmergencyClick);
        console.log('Emergency header button initialized');
    }
    
    if (emergencyCardBtn) {
        emergencyCardBtn.addEventListener('click', handleEmergencyClick);
        console.log('Emergency card button initialized');
    }
    
    // Also handle any dynamically created emergency buttons
    document.addEventListener('click', function(e) {
        if (e.target && (e.target.id === 'emergencyBtn' || e.target.id === 'emergencyCardBtn' || e.target.classList.contains('emergency-card-btn'))) {
            handleEmergencyClick(e);
        }
    });
});
</script>
{% endblock %}
