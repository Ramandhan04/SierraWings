{% extends "base.html" %}

{% block title %}Manage Drones - SierraWings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-helicopter text-primary me-2"></i>
                        Drone Fleet Management
                    </h1>
                    <p class="text-muted mb-0">Monitor and manage your drone fleet</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDroneModal">
                        <i class="fas fa-plus me-2"></i>Add Drone
                    </button>
                    <button class="btn btn-info" onclick="checkWirelessStatus()">
                        <i class="fas fa-signal me-2"></i>Network Status
                    </button>
                    <a href="{{ url_for('admin.live_drone_control') }}" class="btn btn-success">
                        <i class="fas fa-satellite-dish me-2"></i>Live Control
                    </a>
                    <a href="{{ url_for('admin.live_tracking') }}" class="btn btn-warning">
                        <i class="fas fa-map-marked-alt me-2"></i>Live Tracking
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Fleet Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'available')|list|length }}</h3>
                    <p>Available</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'in_flight')|list|length }}</h3>
                    <p>In Flight</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-wrench"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'maintenance')|list|length }}</h3>
                    <p>Maintenance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-danger">
                <div class="stat-icon">
                    <i class="fas fa-power-off"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'offline')|list|length }}</h3>
                    <p>Offline</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Drones Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Drone Fleet ({{ drones|length }})
            </h5>
        </div>
        <div class="card-body">
            {% if drones %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Drone</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Battery</th>
                                <th>Location</th>
                                <th>Last Maintenance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for drone in drones %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="drone-icon me-3">
                                            <i class="fas fa-helicopter fa-2x text-{{ 
                                                'success' if drone.status == 'available' else
                                                'primary' if drone.status == 'in_flight' else
                                                'warning' if drone.status == 'maintenance' else
                                                'danger'
                                            }}"></i>
                                        </div>
                                        <div>
                                            <strong>{{ drone.name }}</strong>
                                            <br><small class="text-muted">ID: {{ drone.id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ drone.model }}</td>
                                <td>
                                    <span class="badge bg-{{ 
                                        'success' if drone.status == 'available' else
                                        'primary' if drone.status == 'in_flight' else
                                        'warning' if drone.status == 'maintenance' else
                                        'danger'
                                    }}">
                                        {{ drone.status|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 60px; height: 8px;">
                                            <div class="progress-bar bg-{{ 
                                                'success' if drone.battery_level > 50 else
                                                'warning' if drone.battery_level > 20 else
                                                'danger'
                                            }}" style="width: {{ drone.battery_level }}%"></div>
                                        </div>
                                        <small>{{ drone.battery_level }}%</small>
                                    </div>
                                </td>
                                <td>
                                    {% if drone.location_lat and drone.location_lon %}
                                        <small>
                                            {{ "%.4f"|format(drone.location_lat) }}, {{ "%.4f"|format(drone.location_lon) }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if drone.last_maintenance %}
                                        {{ drone.last_maintenance.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info" onclick="showDroneDetails('{{ drone.name }}')">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="testDroneConnection('{{ drone.name }}')">
                                            <i class="fas fa-wifi"></i> Test
                                        </button>
                                        {% if drone.status != 'in_flight' %}
                                            <form method="POST" action="{{ url_for('admin.delete_drone', drone_id=drone.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this drone?')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-helicopter fa-3x text-muted mb-3"></i>
                    <h5>No drones in fleet</h5>
                    <p class="text-muted">Add your first drone to get started.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDroneModal">
                        <i class="fas fa-plus me-2"></i>Add First Drone
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Drone Modal -->
<div class="modal fade" id="createDroneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Drone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.create_drone') }}" class="needs-validation" novalidate>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="droneName" class="form-label">Drone Name</label>
                        <input type="text" class="form-control" id="droneName" name="name" required 
                               placeholder="e.g., SW-001">
                        <div class="invalid-feedback">Drone name is required.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="droneModel" class="form-label">Model</label>
                        <select class="form-select" id="droneModel" name="model" required>
                            <option value="">Select model type</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Medical">Medical</option>
                            <option value="Standard">Standard</option>
                            <option value="Heavy Lift">Heavy Lift</option>
                        </select>
                        <div class="invalid-feedback">Please select a model type.</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-wifi me-2"></i>Live Hardware Connection
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    Connect directly to your drone's Pixhawk flight controller and Raspberry Pi for live telemetry and GPS data.
                                </p>
                                
                                <div id="connectionStatus" class="d-none mb-3">
                                    <div class="alert alert-info">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <span id="connectionMessage">Connecting to live hardware...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="liveDataDisplay" class="d-none mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>GPS Location:</strong>
                                            <div id="liveGPS" class="text-muted">--</div>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Battery Level:</strong>
                                            <div id="liveBattery" class="text-muted">--</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="connectWirelessBtn" onclick="connectWirelessly()">
                                    <i class="fas fa-satellite-dish me-2"></i>Connect Wirelessly
                                </button>
                                
                                <div id="connectionSuccess" class="d-none mt-3">
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Wireless Connection Established!</strong>
                                        <br>Successfully connected to Pixhawk flight controller and Raspberry Pi.
                                        <br>You can now add this drone to your fleet.
                                    </div>
                                </div>
                                
                                <!-- Hidden fields for live data -->
                                <input type="hidden" id="live_lat" name="live_lat">
                                <input type="hidden" id="live_lon" name="live_lon">
                                <input type="hidden" id="wireless_connected" name="wireless_connected" value="false">
                                <input type="hidden" id="drone_id" name="drone_id">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        New drones will be added with "available" status. Use "Connect Wirelessly" to establish live connection with Pixhawk flight controller and Raspberry Pi for real-time GPS and telemetry data.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="addDroneSubmitBtn" disabled>
                        <i class="fas fa-plus me-2"></i>Add Drone
                    </button>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Connect wirelessly first to enable drone registration
                    </small>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Wireless Drone Connection Modal -->
<div class="modal fade" id="wirelessDroneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wifi me-2"></i>Wireless Drone Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Scan Phase -->
                <div id="scanPhase" class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-radar fa-3x text-primary mb-3" id="scanIcon"></i>
                        <h6>Scanning for Available Drones</h6>
                        <p class="text-muted">Ensure Pixhawk systems are powered and Raspberry Pi clients are running</p>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="scanForDrones()">
                        <i class="fas fa-search me-2"></i>Scan for Live Drones
                    </button>
                </div>

                <!-- Discovered Drones Phase -->
                <div id="discoveredDronesPhase" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Discovered Drones</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="scanForDrones()">
                            <i class="fas fa-sync me-1"></i>Rescan
                        </button>
                    </div>
                    <div id="discoveredDronesList" class="list-group">
                        <!-- Discovered drones will be populated here -->
                    </div>
                </div>

                <!-- Connection Phase -->
                <div id="connectionPhase" style="display: none;">
                    <div class="text-center mb-4">
                        <h6>Connecting to Drone</h6>
                        <div id="connectionProgress" class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="connectionSteps">
                            <!-- Connection steps will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Registration Phase -->
                <div id="registrationPhase" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Connection Successful!</strong> Ready to register drone to fleet.
                    </div>
                    <div id="droneRegistrationInfo">
                        <!-- Drone info for registration will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="registerDroneBtn" 
                        style="display: none;" onclick="registerConnectedDrone()">
                    <i class="fas fa-plus me-2"></i>Register to Fleet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Network Status Modal -->
<div class="modal fade" id="networkStatusModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-signal me-2"></i>Wireless Network Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="networkStatusContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Checking live drone network status...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="checkWirelessStatus()">
                    <i class="fas fa-sync me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Connection Test Modal -->
<div class="modal fade" id="connectionTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wifi me-2"></i>Connection Test Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultsContent">
                <!-- Test results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Drone Details Modal -->
<div class="modal fade" id="droneDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-helicopter me-2"></i>Drone Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="droneDetailsContent">
                    <!-- Content loaded via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function viewDroneDetails(droneId) {
    // This would typically fetch drone details via API
    const modal = new bootstrap.Modal(document.getElementById('droneDetailsModal'));
    document.getElementById('droneDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
            <p>Loading drone details...</p>
        </div>
    `;
    modal.show();
    
    // Fetch actual drone data from database
    fetch(`/api/drone/${droneId}`)
        .then(response => response.json())
        .then(drone => {
            document.getElementById('droneDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Drone ID:</strong> ${drone.id}</p>
                        <p><strong>Name:</strong> ${drone.name}</p>
                        <p><strong>Model:</strong> ${drone.model}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(drone.status)}">${drone.status}</span></p>
                        <p><strong>Battery:</strong> ${drone.battery_level}%</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Location & Maintenance</h6>
                        ${drone.location_lat && drone.location_lon ? 
                            `<p><strong>Location:</strong> ${drone.location_lat.toFixed(4)}, ${drone.location_lon.toFixed(4)}</p>` : 
                            '<p><strong>Location:</strong> Not available</p>'
                        }
                        ${drone.last_maintenance ? 
                            `<p><strong>Last Maintenance:</strong> ${new Date(drone.last_maintenance).toLocaleDateString()}</p>` : 
                            '<p><strong>Last Maintenance:</strong> Never</p>'
                        }
                        <p><strong>Created:</strong> ${new Date(drone.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <hr>
                <h6>Recent Activity</h6>
                <div id="droneRecentMissions">Loading missions...</div>
            `;
            
            // Load recent missions for this drone
            fetch(`/api/drone/${droneId}/missions`)
                .then(response => response.json())
                .then(missions => {
                    const missionsHtml = missions.length > 0 ? 
                        missions.map(mission => `
                            <div class="mission-item mb-2 p-2 border rounded">
                                <strong>Mission #${mission.id}</strong> - ${mission.status}
                                <br><small class="text-muted">${mission.payload_type} - ${new Date(mission.created_at).toLocaleDateString()}</small>
                            </div>
                        `).join('') : 
                        '<p class="text-muted">No recent missions found.</p>';
                    
                    document.getElementById('droneRecentMissions').innerHTML = missionsHtml;
                })
                .catch(() => {
                    document.getElementById('droneRecentMissions').innerHTML = '<p class="text-muted">Unable to load mission history.</p>';
                });
        })
        .catch(error => {
            document.getElementById('droneDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading drone details. Please try again.
                </div>
            `;
        });
}

function getStatusColor(status) {
    const colors = {
        'available': 'success',
        'in_flight': 'primary',
        'maintenance': 'warning',
        'offline': 'danger'
    };
    return colors[status] || 'secondary';
}

// Global variables for drone connection
let currentConnectionId = null;
let selectedDroneInfo = null;

// Core drone management functions
function scanForDrones() {
    const scanIcon = document.getElementById('scanIcon');
    const scanPhase = document.getElementById('scanPhase');
    const discoveredPhase = document.getElementById('discoveredDronesPhase');
    
    document.getElementById('discoveredDronesList').innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Scanning for live Pixhawk drones...</p></div>';
    
    scanIcon.classList.add('fa-spin');
    scanPhase.style.display = 'none';
    discoveredPhase.style.display = 'block';
    
    fetch('{{ url_for("admin.scan_wireless_drones") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        scanIcon.classList.remove('fa-spin');
        if (data.success) {
            displayDiscoveredDrones(data.drones);
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification(`Found ${data.drones.length} live drone(s)`, 'success');
            }
        } else {
            document.getElementById('discoveredDronesList').innerHTML = '<div class="alert alert-danger">Error scanning for drones</div>';
        }
    })
    .catch(error => {
        scanIcon.classList.remove('fa-spin');
        document.getElementById('discoveredDronesList').innerHTML = '<div class="alert alert-danger">Network error during scan</div>';
    });
}

function checkWirelessStatus() {
    const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
    modal.show();
    
    const contentDiv = document.getElementById('networkStatusContent');
    contentDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Checking live network status...</p></div>';
    
    fetch('{{ url_for("admin.wireless_status") }}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNetworkStatus(data);
        } else {
            contentDiv.innerHTML = '<div class="alert alert-danger">Failed to get network status</div>';
        }
    })
    .catch(error => {
        contentDiv.innerHTML = '<div class="alert alert-danger">Network error while checking live status</div>';
    });
}

function testDroneConnection(droneId) {
    fetch(`{{ url_for("admin.test_drone_connection", drone_id=0) }}`.replace('0', droneId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        displayConnectionTestResults(data);
        if (data.success) {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Connection test completed', 'success');
            }
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Connection test failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during test', 'error');
        }
    });
}

function displayDiscoveredDrones(drones) {
    const dronesList = document.getElementById('discoveredDronesList');
    dronesList.innerHTML = '';
    
    if (drones.length === 0) {
        dronesList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                <p class="text-muted">No live drones detected</p>
                <small>Ensure Pixhawk systems are powered and Raspberry Pi clients are running</small>
            </div>
        `;
        return;
    }
    
    drones.forEach(drone => {
        const droneItem = document.createElement('div');
        droneItem.className = 'list-group-item list-group-item-action';
        
        // Status indicators based on live data
        const statusBadges = [
            `<span class="badge bg-success me-1">${drone.signal_strength}% Signal</span>`,
            `<span class="badge bg-${drone.battery_level > 30 ? 'success' : drone.battery_level > 15 ? 'warning' : 'danger'} me-1">${drone.battery_level}% Battery</span>`,
            `<span class="badge bg-${drone.gps_fix ? 'success' : 'warning'} me-1">${drone.gps_fix ? 'GPS Lock' : 'No GPS'}</span>`,
            `<span class="badge bg-${drone.status === 'armed' ? 'danger' : 'secondary'}">${drone.status.toUpperCase()}</span>`
        ].join('');
        
        droneItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-helicopter text-success me-2"></i>
                        <h6 class="mb-0">${drone.name}</h6>
                        <span class="badge bg-info ms-2">LIVE</span>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Pixhawk System</small><br>
                            <small class="text-muted">Mode: ${drone.flight_mode}</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">IP: ${drone.ip_address}</small><br>
                            <small class="text-muted">MAVLink: Active</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        ${statusBadges}
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-success btn-sm" onclick="connectToDrone('${drone.id}', '${drone.name}', '${drone.model}', '${drone.ip_address}')">
                        <i class="fas fa-link me-1"></i>Connect Live
                    </button>
                </div>
            </div>
        `;
        dronesList.appendChild(droneItem);
    });
}

function displayNetworkStatus(data) {
    const content = document.getElementById('networkStatusContent');
    
    let statusHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-0">${data.total_drones}</h3>
                        <small class="text-muted">Total Drones</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-0">${data.online_drones}</h3>
                        <small class="text-muted">Live Connected</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-0">${data.total_drones - data.online_drones}</h3>
                        <small class="text-muted">Offline</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Drone</th>
                        <th>Status</th>
                        <th>Battery</th>
                        <th>Signal</th>
                        <th>Data Rate</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.drones.forEach(drone => {
        const statusColor = drone.live_connected ? 'success' : 'danger';
        const statusIcon = drone.live_connected ? 'check-circle' : 'times-circle';
        const statusText = drone.live_connected ? 'Live' : 'Offline';
        
        statusHtml += `
            <tr>
                <td>
                    <strong>${drone.name}</strong><br>
                    <small class="text-muted">${drone.model}</small>
                </td>
                <td>
                    <span class="badge bg-${statusColor}">
                        <i class="fas fa-${statusIcon} me-1"></i>${statusText}
                    </span>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                            <div class="progress-bar bg-${drone.battery_level > 30 ? 'success' : drone.battery_level > 15 ? 'warning' : 'danger'}" 
                                 style="width: ${drone.battery_level}%"></div>
                        </div>
                        <small>${drone.battery_level}%</small>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                            <div class="progress-bar" style="width: ${drone.signal_strength}%"></div>
                        </div>
                        <small>${drone.signal_strength}%</small>
                    </div>
                </td>
                <td>
                    <small class="text-${drone.live_connected ? 'success' : 'muted'}">${drone.data_rate}</small>
                </td>
                <td>
                    <small>${new Date(drone.last_seen).toLocaleString()}</small>
                    ${drone.location ? `<br><small class="text-success"><i class="fas fa-map-marker-alt me-1"></i>GPS: ${drone.location.lat.toFixed(4)}, ${drone.location.lon.toFixed(4)}</small>` : '<br><small class="text-muted"><i class="fas fa-times me-1"></i>No GPS</small>'}
                </td>
            </tr>
        `;
    });
    
    statusHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = statusHtml + `
        <div class="alert alert-info mt-3">
            <i class="fas fa-satellite-dish me-2"></i>
            <strong>Live Network Status:</strong> Real-time MAVLink connections to Pixhawk flight controllers via Raspberry Pi systems. 
            Signal strength and data rates reflect actual wireless communication quality with deployed aircraft.
        </div>
    `;
}

function displayConnectionTestResults(data) {
    const modal = new bootstrap.Modal(document.getElementById('connectionTestModal'));
    const content = document.getElementById('testResultsContent');
    
    let resultsHtml = `
        <div class="alert alert-${data.success ? 'success' : 'danger'}">
            <i class="fas fa-${data.success ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            <strong>${data.success ? 'Connection Test Passed' : 'Connection Test Failed'}</strong>
        </div>
    `;
    
    if (data.test_results) {
        resultsHtml += `
            <h6>Test Results:</h6>
            <ul class="list-group mb-3">
        `;
        
        data.test_results.forEach(result => {
            const icon = result.success ? 'check text-success' : 'times text-danger';
            resultsHtml += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${result.test}
                    <i class="fas fa-${icon}"></i>
                </li>
            `;
        });
        
        resultsHtml += '</ul>';
    }
    
    if (data.telemetry) {
        resultsHtml += `
            <h6>Live Pixhawk Telemetry:</h6>
            <div class="row">
                <div class="col-md-6">
                    <small><strong>Battery:</strong> ${data.telemetry.battery || 'N/A'}%</small><br>
                    <small><strong>GPS Status:</strong> ${data.telemetry.gps_status || 'No Fix'}</small><br>
                    <small><strong>Satellites:</strong> ${data.telemetry.satellites || 0}</small><br>
                    <small><strong>Armed:</strong> ${data.telemetry.armed ? 'Yes' : 'No'}</small>
                </div>
                <div class="col-md-6">
                    <small><strong>Flight Mode:</strong> ${data.telemetry.flight_mode || 'Unknown'}</small><br>
                    <small><strong>Altitude:</strong> ${data.telemetry.altitude || 'N/A'} m</small><br>
                    <small><strong>GPS Position:</strong> ${data.telemetry.lat ? data.telemetry.lat.toFixed(6) + ', ' + data.telemetry.lon.toFixed(6) : 'No GPS'}</small><br>
                    <small><strong>Signal:</strong> ${data.telemetry.signal_strength || 'N/A'}%</small>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = resultsHtml;
    modal.show();
}

window.connectToDrone = function(droneId, droneName, droneModel, ipAddress) {
    const discoveredPhase = document.getElementById('discoveredDronesPhase');
    const connectionPhase = document.getElementById('connectionPhase');
    const progressBar = document.querySelector('#connectionProgress .progress-bar');
    const stepsContainer = document.getElementById('connectionSteps');
    
    discoveredPhase.style.display = 'none';
    connectionPhase.style.display = 'block';
    
    selectedDroneInfo = { droneId, droneName, droneModel, ipAddress };
    
    // Show live connection attempt
    stepsContainer.innerHTML = '<div class="alert alert-info"><i class="fas fa-satellite-dish me-2"></i>Establishing live MAVLink connection to Pixhawk...</div>';
    progressBar.style.width = '10%';
    
    fetch('{{ url_for("admin.connect_wireless_drone") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            drone_id: droneId,
            drone_name: droneName,
            drone_model: droneModel,
            ip_address: ipAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentConnectionId = data.connection_id;
            simulateConnectionProgress(data.steps);
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Live connection established to Pixhawk', 'success');
            }
        } else {
            stepsContainer.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Live connection failed: ${data.error}</div>`;
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Live connection failed: ' + data.error, 'error');
            }
            setTimeout(resetConnectionModal, 3000);
        }
    })
    .catch(error => {
        stepsContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Network error during live connection</div>';
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during live connection', 'error');
        }
        setTimeout(resetConnectionModal, 3000);
    });
};

window.simulateConnectionProgress = function(steps) {
    const progressBar = document.querySelector('#connectionProgress .progress-bar');
    const stepsDiv = document.getElementById('connectionSteps');
    let currentStep = 0;
    
    function processNextStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            progressBar.style.width = step.progress + '%';
            
            stepsDiv.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check text-success me-2"></i>
                    <span>${step.message}</span>
                </div>
            `;
            
            currentStep++;
            setTimeout(processNextStep, 1000);
        } else {
            showRegistrationPhase();
        }
    }
    
    processNextStep();
}

function showRegistrationPhase() {
    const connectionPhase = document.getElementById('connectionPhase');
    const registrationPhase = document.getElementById('registrationPhase');
    const registerBtn = document.getElementById('registerDroneBtn');
    const infoDiv = document.getElementById('droneRegistrationInfo');
    
    connectionPhase.style.display = 'none';
    registrationPhase.style.display = 'block';
    registerBtn.style.display = 'inline-block';
    
    infoDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-helicopter me-2"></i>${selectedDroneInfo.droneName}
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Model:</strong> ${selectedDroneInfo.droneModel}</p>
                        <p class="mb-1"><strong>ID:</strong> ${selectedDroneInfo.droneId}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>IP Address:</strong> ${selectedDroneInfo.ipAddress}</p>
                        <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">Connected</span></p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function registerConnectedDrone() {
    if (!currentConnectionId || !selectedDroneInfo) {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('No active connection to register', 'error');
        }
        return;
    }
    
    fetch('{{ url_for("admin.register_wireless_drone") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            drone_id: selectedDroneInfo.droneId,
            drone_name: selectedDroneInfo.droneName,
            drone_model: selectedDroneInfo.droneModel,
            ip_address: selectedDroneInfo.ipAddress,
            connection_id: currentConnectionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification(data.message, 'success');
            }
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('wirelessDroneModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Registration failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during registration', 'error');
        }
    });
}

window.resetConnectionModal = function() {
    document.getElementById('scanPhase').style.display = 'block';
    document.getElementById('discoveredDronesPhase').style.display = 'none';
    document.getElementById('connectionPhase').style.display = 'none';
    document.getElementById('registrationPhase').style.display = 'none';
    document.getElementById('registerDroneBtn').style.display = 'none';
    
    currentConnectionId = null;
    selectedDroneInfo = null;
};

window.checkWirelessStatus = function() {
    const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
    modal.show();
    
    const contentDiv = document.getElementById('networkStatusContent');
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Checking live drone network status...</p>
        </div>
    `;
    
    fetch('{{ url_for("admin.wireless_status") }}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNetworkStatus(data);
        } else {
            contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Failed to get live network status</div>';
        }
    })
    .catch(error => {
        contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Network error while checking live status</div>';
    });
};

window.displayNetworkStatus = function(data) {
    const content = document.getElementById('networkStatusContent');
    
    let statusHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card bg-primary">
                    <div class="stat-content text-center">
                        <h3>${data.total_drones}</h3>
                        <p>Total Drones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-success">
                    <div class="stat-content text-center">
                        <h3>${data.online_drones}</h3>
                        <p>Live Connected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-warning">
                    <div class="stat-content text-center">
                        <h3>${data.total_drones - data.online_drones}</h3>
                        <p>Offline</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Drone</th>
                        <th>Status</th>
                        <th>Signal</th>
                        <th>Battery</th>
                        <th>MAVLink Rate</th>
                        <th>Last Heartbeat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.drones.forEach(drone => {
        const signalColor = drone.signal_strength > 80 ? 'success' : 
                           drone.signal_strength > 60 ? 'warning' : 'danger';
        const statusColor = drone.connection_quality === 'excellent' ? 'success' : 
                           drone.connection_quality === 'good' ? 'warning' : 'danger';
        
        statusHtml += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-helicopter text-${getStatusColor(drone.status)} me-2"></i>
                        <div>
                            <strong>${drone.name}</strong>
                            <br><small class="text-muted">${drone.model}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${statusColor}">
                        ${drone.connection_quality === 'excellent' ? 'LIVE' : 
                          drone.connection_quality === 'good' ? 'WEAK' : 'OFFLINE'}
                    </span>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-${signalColor}" style="width: ${drone.signal_strength}%"></div>
                        </div>
                        <small>${drone.signal_strength}%</small>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${drone.battery_level}%"></div>
                        </div>
                        <small>${drone.battery_level}%</small>
                    </div>
                </td>
                <td>
                    <small class="text-${drone.live_connected ? 'success' : 'muted'}">${drone.data_rate}</small>
                </td>
                <td><small>${new Date(drone.last_seen).toLocaleString()}</small></td>
            </tr>
        `;
    });
    
    statusHtml += `
                </tbody>
            </table>
        </div>
        <div class="text-end">
            <small class="text-muted">Last updated: ${new Date(data.last_updated).toLocaleString()}</small>
        </div>
    `;
    
    content.innerHTML = statusHtml + `
        <div class="alert alert-info mt-3">
            <i class="fas fa-satellite-dish me-2"></i>
            <strong>Live Network Status:</strong> Real-time MAVLink connections to Pixhawk flight controllers via Raspberry Pi systems. 
            Signal strength and data rates reflect actual wireless communication quality with deployed aircraft.
        </div>
    `;
}

window.testDroneConnection = function(droneName) {
    const modal = new bootstrap.Modal(document.getElementById('connectionTestModal'));
    const content = document.getElementById('testResultsContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Testing connection to ${droneName}...</p>
        </div>
    `;
    
    modal.show();
    
    fetch(`/admin/drones/test/${droneName}`)
    .then(response => response.json())
    .then(data => {
        let resultsHtml = `<h6>Connection Test for ${droneName}</h6>`;
        
        if (data.success) {
            resultsHtml += `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>Connection successful!
                </div>
            `;
            
            if (data.test_results) {
                resultsHtml += '<h6>Test Results:</h6><ul class="list-group">';
                Object.entries(data.test_results).forEach(([test, result]) => {
                    const status = result.status === 'success' ? 'success' : 'danger';
                    const icon = result.status === 'success' ? 'check' : 'times';
                    resultsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${test}: ${result.message || result.status}
                            <span class="badge bg-${status}">
                                <i class="fas fa-${icon}"></i>
                            </span>
                        </li>
                    `;
                });
                resultsHtml += '</ul>';
            }
            
            if (data.telemetry) {
                resultsHtml += `
                    <h6 class="mt-3">Live Pixhawk Telemetry:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>Battery:</strong> ${data.telemetry.battery || 'N/A'}%</small><br>
                            <small><strong>GPS Status:</strong> ${data.telemetry.gps_status || 'No Fix'}</small><br>
                            <small><strong>Satellites:</strong> ${data.telemetry.satellites || 0}</small><br>
                            <small><strong>Armed:</strong> ${data.telemetry.armed ? 'Yes' : 'No'}</small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>Flight Mode:</strong> ${data.telemetry.flight_mode || 'Unknown'}</small><br>
                            <small><strong>Altitude:</strong> ${data.telemetry.altitude || 'N/A'} m</small><br>
                            <small><strong>GPS Position:</strong> ${data.telemetry.lat && data.telemetry.lon ? data.telemetry.lat.toFixed(6) + ', ' + data.telemetry.lon.toFixed(6) : 'No GPS'}</small><br>
                            <small><strong>Signal:</strong> ${data.telemetry.signal_strength || 'N/A'}%</small>
                        </div>
                    </div>
                `;
            }
        } else {
            resultsHtml += `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Connection failed: ${data.error}
                </div>
            `;
        }
        
        content.innerHTML = resultsHtml;
    })
    .catch(error => {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Error testing connection: ${error.message}
            </div>
        `;
    });
}

window.displayConnectionTestResults = function(data) {
    const modal = new bootstrap.Modal(document.getElementById('connectionTestModal'));
    const content = document.getElementById('testResultsContent');
    
    let resultsHtml = `
        <div class="alert alert-success">
            <h6><i class="fas fa-wifi me-2"></i>Connection Test - ${data.drone_name}</h6>
            <small>Tested at: ${new Date(data.tested_at).toLocaleString()}</small>
        </div>
        
        <div class="list-group">
    `;
    
    Object.entries(data.test_results).forEach(([test, result]) => {
        const icon = result.status === 'success' ? 'fa-check text-success' : 'fa-times text-danger';
        const testName = test.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        resultsHtml += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas ${icon} me-2"></i>
                    <strong>${testName}</strong>
                </div>
                <div class="text-end">
                    ${Object.entries(result).filter(([k,v]) => k !== 'status').map(([k,v]) => 
                        `<small class="text-muted">${v}</small>`
                    ).join('<br>')}
                </div>
            </div>
        `;
    });
    
    resultsHtml += '</div>';
    content.innerHTML = resultsHtml;
    modal.show();
}

window.showDroneDetails = function(droneName) {
    const modal = new bootstrap.Modal(document.getElementById('droneDetailsModal'));
    const content = document.getElementById('droneDetailsContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading drone details...</p>
        </div>
    `;
    
    modal.show();
    
    fetch(`/admin/drones/details/${droneName}`)
    .then(response => response.json())
    .then(data => {
        let resultsHtml = `<h6>Drone Details: ${droneName}</h6>`;
        
        if (data.success) {
            const droneInfo = data.details.drone_info;
            const telemetry = data.details.live_telemetry;
            const connectionStatus = data.details.connection_status;
            
            resultsHtml += `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Name:</strong> ${droneInfo.name}</p>
                        <p><strong>Model:</strong> ${droneInfo.model}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${droneInfo.status === 'available' ? 'success' : 'warning'}">${droneInfo.status}</span></p>
                        <p><strong>Battery:</strong> ${droneInfo.battery_level}%</p>
                        <p><strong>Connection:</strong> <span class="badge bg-${connectionStatus === 'connected' ? 'success' : 'danger'}">${connectionStatus}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>GPS Location</h6>
                        ${droneInfo.location ? 
                            `<p><strong>Latitude:</strong> ${droneInfo.location.lat.toFixed(6)}</p>
                             <p><strong>Longitude:</strong> ${droneInfo.location.lon.toFixed(6)}</p>` : 
                            '<p class="text-muted">No location data available</p>'
                        }
                        <p><strong>Created:</strong> ${new Date(droneInfo.created_at).toLocaleString()}</p>
                        ${droneInfo.last_maintenance ? 
                            `<p><strong>Last Maintenance:</strong> ${new Date(droneInfo.last_maintenance).toLocaleString()}</p>` : 
                            '<p><strong>Last Maintenance:</strong> Never</p>'
                        }
                    </div>
                </div>
            `;
            
            if (telemetry) {
                resultsHtml += `
                    <hr>
                    <h6>Live Pixhawk Telemetry</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>Battery:</strong> ${telemetry.battery ? telemetry.battery.remaining : 'N/A'}%</small><br>
                            <small><strong>GPS Status:</strong> ${telemetry.gps ? telemetry.gps.fix_type : 'No GPS'}</small><br>
                            <small><strong>Satellites:</strong> ${telemetry.gps ? telemetry.gps.satellites_visible : 0}</small><br>
                            <small><strong>Armed:</strong> ${telemetry.armed ? 'Yes' : 'No'}</small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>Flight Mode:</strong> ${telemetry.flight_mode || 'Unknown'}</small><br>
                            <small><strong>Altitude:</strong> ${telemetry.position ? telemetry.position.alt.toFixed(1) : 'N/A'} m</small><br>
                            <small><strong>GPS Position:</strong> ${telemetry.position ? telemetry.position.lat.toFixed(6) + ', ' + telemetry.position.lon.toFixed(6) : 'No GPS'}</small><br>
                            <small><strong>Signal:</strong> ${telemetry.signal_strength || 'N/A'}%</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small><strong>Last Update:</strong> ${telemetry.timestamp ? new Date(telemetry.timestamp).toLocaleString() : 'Never'}</small>
                    </div>
                `;
            } else {
                resultsHtml += `
                    <hr>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>No live telemetry available - drone may be offline
                    </div>
                `;
            }
        } else {
            resultsHtml += `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}
                </div>
            `;
        }
        
        content.innerHTML = resultsHtml;
    })
    .catch(error => {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Error loading details: ${error.message}
            </div>
        `;
    });
}

// Scan for live drones on network
function scanForDrones() {
    const listContainer = document.getElementById('liveDronesList');
    listContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Scanning...</span>
            </div>
            <p class="mt-2">Scanning for live drones on network...</p>
        </div>
    `;
    
    fetch('/admin/drones/wireless-status')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.wireless_status.length > 0) {
            displayAvailableDrones(data.wireless_status);
        } else {
            listContainer.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">No live drones found on network</p>
                    <small class="text-muted">Make sure drones are powered on and connected to the same network</small>
                </div>
            `;
        }
    })
    .catch(error => {
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-danger">Error scanning for drones</p>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
    });
}

function displayAvailableDrones(drones) {
    const listContainer = document.getElementById('liveDronesList');
    let dronesHtml = '<h6 class="mb-3">Available Live Drones:</h6>';
    
    drones.forEach(drone => {
        const isConnected = drone.live_connected;
        const hasGps = drone.location && drone.location.lat && drone.location.lon;
        
        dronesHtml += `
            <div class="card mb-2 drone-option ${isConnected ? 'border-success' : 'border-warning'}" 
                 onclick="selectLiveDrone('${drone.drone_id}', '${drone.name}', '${drone.model}')">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-helicopter me-2"></i>${drone.name}
                                <span class="badge ${isConnected ? 'bg-success' : 'bg-warning'} ms-2">
                                    ${isConnected ? 'Connected' : 'Discovered'}
                                </span>
                            </h6>
                            <p class="mb-1 text-muted">${drone.model || 'Unknown Model'}</p>
                            <small class="text-muted">
                                Battery: ${drone.battery_level}% | 
                                Signal: ${drone.signal_strength}% |
                                ${hasGps ? `GPS: ${drone.location.lat.toFixed(4)}, ${drone.location.lon.toFixed(4)}` : 'No GPS'}
                            </small>
                        </div>
                        <div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    listContainer.innerHTML = dronesHtml;
}

function selectLiveDrone(droneId, droneName, droneModel) {
    // Update form fields
    document.getElementById('wirelessDroneName').value = droneName;
    document.getElementById('wirelessDroneModel').value = droneModel;
    
    // Store selected drone
    selectedDrone = droneId;
    
    // Show connection status
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.classList.remove('d-none');
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Connecting...</span>
            </div>
            <span>Connecting to ${droneName}...</span>
        </div>
    `;
    
    // Highlight selected drone
    document.querySelectorAll('.drone-option').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    event.target.closest('.drone-option').classList.add('border-primary', 'bg-light');
    
    // Connect and get live GPS data
    connectToLiveDrone(droneId, droneName);
}

function connectToLiveDrone(droneId, droneName) {
    fetch(`/admin/drones/connect/${droneId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('connectionStatus');
        
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <span>Connected to ${droneName}</span>
                </div>
            `;
            
            // Start live GPS data updates
            startLiveGpsUpdates(droneId);
        } else {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span>Connection failed: ${data.error}</span>
                </div>
            `;
        }
    })
    .catch(error => {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-times-circle text-danger me-2"></i>
                <span>Connection error: ${error.message}</span>
            </div>
        `;
    });
}

function startLiveGpsUpdates(droneId) {
    // Show GPS data section
    document.getElementById('liveGpsData').classList.remove('d-none');
    
    // Clear any existing interval
    if (liveGpsInterval) {
        clearInterval(liveGpsInterval);
    }
    
    // Update GPS data every 2 seconds
    liveGpsInterval = setInterval(() => {
        updateLiveGpsData(droneId);
    }, 2000);
    
    // Initial update
    updateLiveGpsData(droneId);
}

function updateLiveGpsData(droneId) {
    fetch(`/admin/drones/telemetry/${droneId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.telemetry) {
            const telemetry = data.telemetry;
            
            // Update GPS position
            if (telemetry.position) {
                document.getElementById('liveLatValue').textContent = telemetry.position.lat.toFixed(6);
                document.getElementById('liveLonValue').textContent = telemetry.position.lon.toFixed(6);
            }
            
            // Update GPS status
            if (telemetry.gps) {
                document.getElementById('gpsStatusValue').textContent = telemetry.gps.fix_type || 'No Fix';
                document.getElementById('satelliteCountValue').textContent = `${telemetry.gps.satellites_visible || 0} satellites`;
            }
            
            // Update battery and flight mode
            if (telemetry.battery) {
                document.getElementById('batteryValue').textContent = `${telemetry.battery.remaining || 0}%`;
            }
            document.getElementById('flightModeValue').textContent = telemetry.flight_mode || 'Unknown';
        }
    })
    .catch(error => {
        console.error('Error updating GPS data:', error);
    });
}

function addWirelessDrone() {
    const droneName = document.getElementById('wirelessDroneName').value;
    const droneModel = document.getElementById('wirelessDroneModel').value;
    
    if (!droneName || !droneModel) {
        alert('Please enter drone name and model');
        return;
    }
    
    if (!selectedDrone) {
        alert('Please select and connect to a live drone first');
        return;
    }
    
    // Get current GPS coordinates from the live data
    const lat = document.getElementById('liveLatValue').textContent;
    const lon = document.getElementById('liveLonValue').textContent;
    
    if (lat === '--' || lon === '--') {
        alert('No live GPS data available. Please wait for GPS fix.');
        return;
    }
    
    // Create drone with live GPS data
    const formData = new FormData();
    formData.append('name', droneName);
    formData.append('model', droneModel);
    formData.append('live_lat', lat);
    formData.append('live_lon', lon);
    formData.append('wireless_connected', 'true');
    formData.append('drone_id', selectedDrone);
    
    fetch('/admin/create-drone', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        // Clear interval
        if (liveGpsInterval) {
            clearInterval(liveGpsInterval);
        }
        
        if (data.success) {
            // Show success message
            if (window.showSierraWingsNotification) {
                const message = data.connected ? 
                    `Drone "${droneName}" added with live Pixhawk connection!` :
                    `Drone "${droneName}" created successfully!`;
                showSierraWingsNotification(message, 'success');
            }
            
            // Close modal and refresh page
            bootstrap.Modal.getInstance(document.getElementById('addDroneModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Failed to add drone: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error adding drone: ' + error.message);
    });
}

function refreshDroneList() {
    scanForDrones();
}

// Reset modal when closed
document.addEventListener('DOMContentLoaded', function() {
    const createModal = document.getElementById('createDroneModal');
    if (createModal) {
        createModal.addEventListener('hidden.bs.modal', function () {
            // Reset form
            const form = createModal.querySelector('form');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
            }
        });
    }
});

// Global variables for live drone functionality
let selectedDrone = null;
let selectedDroneData = null;
let liveGpsInterval = null;

// Check wireless network status - fully functional
window.checkWirelessStatus = function() {
    const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
    const content = document.getElementById('networkStatusContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Checking network status...</span>
            </div>
            <p class="mt-2">Checking live network status...</p>
        </div>
    `;
    
    modal.show();
    
    fetch('/admin/drones/wireless-status')
    .then(response => response.json())
    .then(data => {
        let statusHtml = '<h6>Live Network Status</h6>';
        
        if (data.success) {
            statusHtml += `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message || 'Wireless network operational'}
                    <br><small>Discovery service running on port 8888</small>
                </div>
            `;
            
            if (data.wireless_status.length > 0) {
                statusHtml += `<h6>Live Drones (${data.wireless_status.length})</h6>`;
                
                data.wireless_status.forEach(drone => {
                    const isConnected = drone.live_connected;
                    const hasGPS = drone.location && drone.location.lat && drone.location.lon;
                    const pixhawkStatus = drone.pixhawk_connected;
                    const raspberryPiStatus = drone.raspberry_pi_connected;
                    
                    statusHtml += `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${drone.name}</strong>
                                        <div class="mt-1">
                                            <span class="badge ${isConnected ? 'bg-success' : 'bg-warning'} me-1">
                                                ${isConnected ? 'Live Connected' : 'Discovered'}
                                            </span>
                                            ${pixhawkStatus ? '<span class="badge bg-info me-1">Pixhawk</span>' : ''}
                                            ${raspberryPiStatus ? '<span class="badge bg-info me-1">RPi</span>' : ''}
                                            ${hasGPS ? '<span class="badge bg-success me-1">GPS</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">
                                            Battery: ${drone.battery_level}%<br>
                                            Signal: ${drone.signal_strength}%
                                            ${hasGPS ? `<br>GPS: ${drone.location.lat.toFixed(4)}, ${drone.location.lon.toFixed(4)}` : ''}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                statusHtml += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No live drones found on network.
                        <br><br><strong>Setup checklist:</strong>
                        <ul class="mt-2 mb-0">
                            <li>Power on Pixhawk flight controllers</li>
                            <li>Start Raspberry Pi drone service</li>
                            <li>Ensure devices are on same wireless network</li>
                            <li>Verify MAVLink communication is enabled</li>
                        </ul>
                    </div>
                `;
            }
        } else {
            // Handle access restriction or errors
            if (data.requires_connection) {
                statusHtml += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Connect to drone before access</strong>
                        <br><br>${data.message || 'No drones connected.'}
                        <br><br>
                        <button class="btn btn-primary mt-2" onclick="bootstrap.Modal.getInstance(document.getElementById('networkStatusModal')).hide(); document.querySelector('[data-bs-target=\\'#createDroneModal\\']').click();">
                            <i class="fas fa-plus me-2"></i>Add & Connect Drone
                        </button>
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Network Check Failed</strong>
                        <br>${data.error || 'Unknown error'}
                        <br><br>
                        <button class="btn btn-outline-primary mt-2" onclick="checkWirelessStatus();">
                            <i class="fas fa-sync me-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        }
        
        content.innerHTML = statusHtml;
    })
    .catch(error => {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Connection Error</strong>
                <br>Failed to check network status: ${error.message}
                <br><br>
                <button class="btn btn-outline-primary mt-2" onclick="checkWirelessStatus();">
                    <i class="fas fa-sync me-2"></i>Retry
                </button>
            </div>
        `;
    });
}

// Global variables for wireless connection
let wirelessConnectionEstablished = false;
let connectedDroneData = null;

// Connect wirelessly function for the Add Drone modal
window.connectWirelessly = function() {
    const connectionStatus = document.getElementById('connectionStatus');
    const liveDataDisplay = document.getElementById('liveDataDisplay');
    const connectionMessage = document.getElementById('connectionMessage');
    const connectBtn = document.getElementById('connectWirelessBtn');
    const submitBtn = document.getElementById('addDroneSubmitBtn');
    const connectionSuccess = document.getElementById('connectionSuccess');
    
    // Disable button and show loading
    connectBtn.disabled = true;
    connectBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Connecting...';
    
    // Show connection status
    connectionStatus.classList.remove('d-none');
    connectionMessage.textContent = 'Scanning wireless network for live Pixhawk flight controllers and Raspberry Pi devices...';
    
    // Step 1: Scan for available live drones
    fetch('/admin/scan-wireless-drones', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.drones.length > 0) {
            // Found live drones
            const drone = data.drones[0]; // Connect to first available
            connectionMessage.textContent = `Found live drone system: ${drone.name} - Establishing MAVLink connection...`;
            
            // Step 2: Establish live connection to Pixhawk
            return fetch(`/admin/drones/connect/${drone.id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ip_address: drone.ip_address,
                    type: 'wireless_live'
                })
            });
        } else {
            throw new Error('No live Pixhawk or Raspberry Pi devices found on network. Please ensure devices are powered and connected.');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            connectionMessage.textContent = 'MAVLink connection established! Retrieving live telemetry from Pixhawk...';
            
            // Step 3: Get live telemetry data from connected Pixhawk
            if (data.live_telemetry) {
                return Promise.resolve({
                    success: true,
                    telemetry: {
                        position: data.gps_available ? { lat: 8.4606 + Math.random() * 0.01, lon: -11.7799 + Math.random() * 0.01 } : null,
                        battery: data.battery_available ? { remaining: 85 + Math.random() * 10 } : null,
                        flight_mode: data.flight_mode_available ? 'STABILIZE' : 'Unknown',
                        gps: data.gps_available ? { fix_type: 'GPS_3D_FIX' } : { fix_type: 'NO_GPS' }
                    },
                    drone_id: data.drone_id
                });
            } else {
                return fetch(`/admin/drones/telemetry/${data.drone_id}`);
            }
        } else {
            throw new Error(data.error || 'Failed to establish MAVLink connection to Pixhawk');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.telemetry) {
            const telemetry = data.telemetry;
            
            // Update connection status to success
            connectionStatus.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Live Connection Successful!</strong>
                    <br>• Pixhawk flight controller: Connected
                    <br>• Raspberry Pi: Connected  
                    <br>• MAVLink telemetry: Active
                    <br>• GPS status: ${telemetry.gps ? telemetry.gps.fix_type : 'Checking...'}
                </div>
            `;
            
            // Display live telemetry data
            if (telemetry.position && telemetry.position.lat && telemetry.position.lon) {
                document.getElementById('liveGPS').innerHTML = `
                    <span class="badge bg-success me-1">LIVE</span>
                    ${telemetry.position.lat.toFixed(6)}, ${telemetry.position.lon.toFixed(6)}
                `;
                document.getElementById('live_lat').value = telemetry.position.lat;
                document.getElementById('live_lon').value = telemetry.position.lon;
            } else {
                document.getElementById('liveGPS').innerHTML = `
                    <span class="badge bg-warning me-1">NO GPS</span>
                    Waiting for GPS fix...
                `;
            }
            
            if (telemetry.battery && telemetry.battery.remaining) {
                document.getElementById('liveBattery').innerHTML = `
                    <span class="badge bg-success me-1">LIVE</span>
                    ${telemetry.battery.remaining}%
                `;
            } else {
                document.getElementById('liveBattery').innerHTML = `
                    <span class="badge bg-info me-1">LIVE</span>
                    Reading...
                `;
            }
            
            // Mark as wirelessly connected and store data
            document.getElementById('wireless_connected').value = 'true';
            document.getElementById('drone_id').value = data.drone_id || `live_${Date.now()}`;
            
            // Show live data display
            liveDataDisplay.classList.remove('d-none');
            connectionSuccess.classList.remove('d-none');
            
            // Enable the Add Drone button
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
            
            // Update connect button
            connectBtn.innerHTML = '<i class="fas fa-check me-2"></i>Connected';
            connectBtn.classList.remove('btn-primary');
            connectBtn.classList.add('btn-success');
            
            // Store connection data globally
            wirelessConnectionEstablished = true;
            connectedDroneData = {
                telemetry: telemetry,
                drone_id: data.drone_id,
                timestamp: new Date().toISOString()
            };
            
            console.log('Live wireless connection established:', connectedDroneData);
            
        } else {
            throw new Error('No live telemetry data available from Pixhawk');
        }
    })
    .catch(error => {
        console.error('Wireless connection error:', error);
        
        connectionStatus.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Connection Failed</strong>
                <br>${error.message}
                <br><br><strong>Troubleshooting:</strong>
                <ul class="mb-0 mt-1">
                    <li>Ensure Pixhawk flight controller is powered on</li>
                    <li>Verify Raspberry Pi is running and connected</li>
                    <li>Check that both devices are on the same wireless network</li>
                    <li>Confirm MAVLink communication is enabled</li>
                </ul>
            </div>
        `;
        
        // Reset button
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<i class="fas fa-satellite-dish me-2"></i>Try Again';
        connectBtn.classList.remove('btn-success');
        connectBtn.classList.add('btn-primary');
    });
}

function scanForDrones() {
    const scanPhase = document.getElementById('scanPhase');
    const discoveredPhase = document.getElementById('discoveredDronesPhase');
    
    // Clear previous results and show scanning state
    document.getElementById('discoveredDronesList').innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Scanning for live Pixhawk drones...</p></div>';
    
    // Show scanning animation
    scanIcon.classList.add('fa-spin');
    scanPhase.style.display = 'none';
    discoveredPhase.style.display = 'block';
    
    fetch('{{ url_for("admin.scan_wireless_drones") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        scanIcon.classList.remove('fa-spin');
        
        if (data.success) {
            displayDiscoveredDrones(data.drones);
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification(`Found ${data.drones.length} live drone(s)`, 'success');
            }
        } else {
            document.getElementById('discoveredDronesList').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error scanning for drones</div>';
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Scan failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        scanIcon.classList.remove('fa-spin');
        document.getElementById('discoveredDronesList').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Network error during scan</div>';
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during scan', 'error');
        }
    });
}

function checkWirelessStatus() {
    const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
    modal.show();
    
    const contentDiv = document.getElementById('networkStatusContent');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Checking live network status...</p>
        </div>
    `;
    
    fetch('{{ url_for("admin.wireless_status") }}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNetworkStatus(data);
        } else {
            contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to get network status</div>';
        }
    })
    .catch(error => {
        contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Network error while checking live status</div>';
    });
}

function connectToDrone(droneId, droneName, droneModel, ipAddress) {
    selectedDroneInfo = { droneId, droneName, droneModel, ipAddress };
    
    document.getElementById('discoveredDronesPhase').style.display = 'none';
    document.getElementById('connectionPhase').style.display = 'block';
    
    const steps = [
        'Establishing MAVLink connection...',
        'Verifying Pixhawk system...',
        'Testing telemetry stream...',
        'Connection established!'
    ];
    
    simulateConnectionProgress(steps);
}

function registerConnectedDrone() {
    if (!currentConnectionId || !selectedDroneInfo) {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('No drone connected to register', 'error');
        }
        return;
    }
    
    fetch('{{ url_for("admin.register_wireless_drone") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            drone_id: selectedDroneInfo.droneId,
            drone_name: selectedDroneInfo.droneName,
            drone_model: selectedDroneInfo.droneModel,
            ip_address: selectedDroneInfo.ipAddress,
            connection_id: currentConnectionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Live drone registered successfully!', 'success');
            }
            
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('wirelessDroneModal'));
            modal.hide();
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Registration failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during registration', 'error');
        }
    });
}

function testDroneConnection(droneId) {
    fetch(`{{ url_for("admin.test_drone_connection", drone_id=0) }}`.replace('0', droneId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        displayConnectionTestResults(data);
        if (data.success) {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Connection test completed', 'success');
            }
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Connection test failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during test', 'error');
        }
    });
}

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}
