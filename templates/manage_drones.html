{% extends "base.html" %}

{% block title %}Manage Drones - SierraWings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-helicopter text-primary me-2"></i>
                        Drone Fleet Management
                    </h1>
                    <p class="text-muted mb-0">Monitor and manage your drone fleet</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDroneModal">
                        <i class="fas fa-plus me-2"></i>Add Drone
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#wirelessDroneModal">
                        <i class="fas fa-wifi me-2"></i>Connect Wireless
                    </button>
                    <button class="btn btn-info" onclick="checkWirelessStatus()">
                        <i class="fas fa-signal me-2"></i>Network Status
                    </button>
                    <a href="{{ url_for('admin.live_drone_control') }}" class="btn btn-success">
                        <i class="fas fa-satellite-dish me-2"></i>Live Control
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Fleet Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'available')|list|length }}</h3>
                    <p>Available</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'in_flight')|list|length }}</h3>
                    <p>In Flight</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-wrench"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'maintenance')|list|length }}</h3>
                    <p>Maintenance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-danger">
                <div class="stat-icon">
                    <i class="fas fa-power-off"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ drones|selectattr('status', 'equalto', 'offline')|list|length }}</h3>
                    <p>Offline</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Drones Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Drone Fleet ({{ drones|length }})
            </h5>
        </div>
        <div class="card-body">
            {% if drones %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Drone</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Battery</th>
                                <th>Location</th>
                                <th>Last Maintenance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for drone in drones %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="drone-icon me-3">
                                            <i class="fas fa-helicopter fa-2x text-{{ 
                                                'success' if drone.status == 'available' else
                                                'primary' if drone.status == 'in_flight' else
                                                'warning' if drone.status == 'maintenance' else
                                                'danger'
                                            }}"></i>
                                        </div>
                                        <div>
                                            <strong>{{ drone.name }}</strong>
                                            <br><small class="text-muted">ID: {{ drone.id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ drone.model }}</td>
                                <td>
                                    <span class="badge bg-{{ 
                                        'success' if drone.status == 'available' else
                                        'primary' if drone.status == 'in_flight' else
                                        'warning' if drone.status == 'maintenance' else
                                        'danger'
                                    }}">
                                        {{ drone.status|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 60px; height: 8px;">
                                            <div class="progress-bar bg-{{ 
                                                'success' if drone.battery_level > 50 else
                                                'warning' if drone.battery_level > 20 else
                                                'danger'
                                            }}" style="width: {{ drone.battery_level }}%"></div>
                                        </div>
                                        <small>{{ drone.battery_level }}%</small>
                                    </div>
                                </td>
                                <td>
                                    {% if drone.location_lat and drone.location_lon %}
                                        <small>
                                            {{ "%.4f"|format(drone.location_lat) }}, {{ "%.4f"|format(drone.location_lon) }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if drone.last_maintenance %}
                                        {{ drone.last_maintenance.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info" onclick="viewDroneDetails({{ drone.id }})">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="testDroneConnection({{ drone.id }})">
                                            <i class="fas fa-wifi"></i> Test
                                        </button>
                                        {% if drone.status != 'in_flight' %}
                                            <form method="POST" action="{{ url_for('admin.delete_drone', drone_id=drone.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this drone?')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-helicopter fa-3x text-muted mb-3"></i>
                    <h5>No drones in fleet</h5>
                    <p class="text-muted">Add your first drone to get started.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDroneModal">
                        <i class="fas fa-plus me-2"></i>Add First Drone
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Drone Modal -->
<div class="modal fade" id="createDroneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Drone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.create_drone') }}" class="needs-validation" novalidate>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Drone Name</label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="e.g., SW-004">
                        <div class="invalid-feedback">Drone name is required.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="model" class="form-label">Model</label>
                        <select class="form-select" id="model" name="model" required>
                            <option value="">Select model</option>
                            <option value="SierraWings Medical">SierraWings Medical</option>
                            <option value="SierraWings Emergency">SierraWings Emergency</option>
                            <option value="SierraWings Standard">SierraWings Standard</option>
                            <option value="SierraWings Heavy Lift">SierraWings Heavy Lift</option>
                        </select>
                        <div class="invalid-feedback">Please select a model.</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        New drones will be added with "available" status and 100% battery level.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Add Drone
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Wireless Drone Connection Modal -->
<div class="modal fade" id="wirelessDroneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wifi me-2"></i>Wireless Drone Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Scan Phase -->
                <div id="scanPhase" class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-radar fa-3x text-primary mb-3" id="scanIcon"></i>
                        <h6>Scanning for Available Drones</h6>
                        <p class="text-muted">Ensure Pixhawk systems are powered and Raspberry Pi clients are running</p>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="scanForDrones()">
                        <i class="fas fa-search me-2"></i>Scan for Live Drones
                    </button>
                </div>

                <!-- Discovered Drones Phase -->
                <div id="discoveredDronesPhase" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Discovered Drones</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="scanForDrones()">
                            <i class="fas fa-sync me-1"></i>Rescan
                        </button>
                    </div>
                    <div id="discoveredDronesList" class="list-group">
                        <!-- Discovered drones will be populated here -->
                    </div>
                </div>

                <!-- Connection Phase -->
                <div id="connectionPhase" style="display: none;">
                    <div class="text-center mb-4">
                        <h6>Connecting to Drone</h6>
                        <div id="connectionProgress" class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="connectionSteps">
                            <!-- Connection steps will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Registration Phase -->
                <div id="registrationPhase" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Connection Successful!</strong> Ready to register drone to fleet.
                    </div>
                    <div id="droneRegistrationInfo">
                        <!-- Drone info for registration will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="registerDroneBtn" 
                        style="display: none;" onclick="registerConnectedDrone()">
                    <i class="fas fa-plus me-2"></i>Register to Fleet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Network Status Modal -->
<div class="modal fade" id="networkStatusModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-signal me-2"></i>Wireless Network Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="networkStatusContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Checking live drone network status...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="checkWirelessStatus()">
                    <i class="fas fa-sync me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Connection Test Modal -->
<div class="modal fade" id="connectionTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wifi me-2"></i>Connection Test Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultsContent">
                <!-- Test results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Drone Details Modal -->
<div class="modal fade" id="droneDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-helicopter me-2"></i>Drone Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="droneDetailsContent">
                    <!-- Content loaded via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function viewDroneDetails(droneId) {
    // This would typically fetch drone details via API
    const modal = new bootstrap.Modal(document.getElementById('droneDetailsModal'));
    document.getElementById('droneDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
            <p>Loading drone details...</p>
        </div>
    `;
    modal.show();
    
    // Fetch actual drone data from database
    fetch(`/api/drone/${droneId}`)
        .then(response => response.json())
        .then(drone => {
            document.getElementById('droneDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Drone ID:</strong> ${drone.id}</p>
                        <p><strong>Name:</strong> ${drone.name}</p>
                        <p><strong>Model:</strong> ${drone.model}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(drone.status)}">${drone.status}</span></p>
                        <p><strong>Battery:</strong> ${drone.battery_level}%</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Location & Maintenance</h6>
                        ${drone.location_lat && drone.location_lon ? 
                            `<p><strong>Location:</strong> ${drone.location_lat.toFixed(4)}, ${drone.location_lon.toFixed(4)}</p>` : 
                            '<p><strong>Location:</strong> Not available</p>'
                        }
                        ${drone.last_maintenance ? 
                            `<p><strong>Last Maintenance:</strong> ${new Date(drone.last_maintenance).toLocaleDateString()}</p>` : 
                            '<p><strong>Last Maintenance:</strong> Never</p>'
                        }
                        <p><strong>Created:</strong> ${new Date(drone.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <hr>
                <h6>Recent Activity</h6>
                <div id="droneRecentMissions">Loading missions...</div>
            `;
            
            // Load recent missions for this drone
            fetch(`/api/drone/${droneId}/missions`)
                .then(response => response.json())
                .then(missions => {
                    const missionsHtml = missions.length > 0 ? 
                        missions.map(mission => `
                            <div class="mission-item mb-2 p-2 border rounded">
                                <strong>Mission #${mission.id}</strong> - ${mission.status}
                                <br><small class="text-muted">${mission.payload_type} - ${new Date(mission.created_at).toLocaleDateString()}</small>
                            </div>
                        `).join('') : 
                        '<p class="text-muted">No recent missions found.</p>';
                    
                    document.getElementById('droneRecentMissions').innerHTML = missionsHtml;
                })
                .catch(() => {
                    document.getElementById('droneRecentMissions').innerHTML = '<p class="text-muted">Unable to load mission history.</p>';
                });
        })
        .catch(error => {
            document.getElementById('droneDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading drone details. Please try again.
                </div>
            `;
        });
}

function getStatusColor(status) {
    const colors = {
        'available': 'success',
        'in_flight': 'primary',
        'maintenance': 'warning',
        'offline': 'danger'
    };
    return colors[status] || 'secondary';
}

// Wireless drone connection functionality
let currentConnectionId = null;
let selectedDroneInfo = null;

// Make functions globally accessible
window.scanForDrones = function() {
    const scanIcon = document.getElementById('scanIcon');
    const scanPhase = document.getElementById('scanPhase');
    const discoveredPhase = document.getElementById('discoveredDronesPhase');
    
    // Clear previous results and show scanning state
    document.getElementById('discoveredDronesList').innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Scanning for live Pixhawk drones...</p></div>';
    
    // Show scanning animation
    scanIcon.classList.add('fa-spin');
    scanPhase.style.display = 'none';
    discoveredPhase.style.display = 'block';
    
    fetch('{{ url_for("admin.scan_wireless_drones") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        scanIcon.classList.remove('fa-spin');
        
        if (data.success) {
            displayDiscoveredDrones(data.drones);
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification(`Found ${data.drones.length} live drones on network`, 'success');
            }
        } else {
            document.getElementById('discoveredDronesList').innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No live drones detected. Ensure Pixhawk systems are powered and Raspberry Pi clients are running.</div>';
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('No live drones found on network', 'warning');
            }
        }
    })
    .catch(error => {
        scanIcon.classList.remove('fa-spin');
        document.getElementById('discoveredDronesList').innerHTML = 
            '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Network scan failed</div>';
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during live scan', 'error');
        }
    });
};

window.displayDiscoveredDrones = function(drones) {
    const dronesList = document.getElementById('discoveredDronesList');
    dronesList.innerHTML = '';
    
    if (drones.length === 0) {
        dronesList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                <p class="text-muted">No live drones detected</p>
                <small>Ensure Pixhawk systems are powered and Raspberry Pi clients are running</small>
            </div>
        `;
        return;
    }
    
    drones.forEach(drone => {
        const droneItem = document.createElement('div');
        droneItem.className = 'list-group-item list-group-item-action';
        
        // Status indicators based on live data
        const statusBadges = [
            `<span class="badge bg-success me-1">${drone.signal_strength}% Signal</span>`,
            `<span class="badge bg-${drone.battery_level > 30 ? 'success' : drone.battery_level > 15 ? 'warning' : 'danger'} me-1">${drone.battery_level}% Battery</span>`,
            `<span class="badge bg-${drone.gps_fix ? 'success' : 'warning'} me-1">${drone.gps_fix ? 'GPS Lock' : 'No GPS'}</span>`,
            `<span class="badge bg-${drone.status === 'armed' ? 'danger' : 'secondary'}">${drone.status.toUpperCase()}</span>`
        ].join('');
        
        droneItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-helicopter text-success me-2"></i>
                        <h6 class="mb-0">${drone.name}</h6>
                        <span class="badge bg-info ms-2">LIVE</span>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Pixhawk System</small><br>
                            <small class="text-muted">Mode: ${drone.flight_mode}</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">IP: ${drone.ip_address}</small><br>
                            <small class="text-muted">MAVLink: Active</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        ${statusBadges}
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-success btn-sm" onclick="connectToDrone('${drone.id}', '${drone.name}', '${drone.model}', '${drone.ip_address}')">
                        <i class="fas fa-link me-1"></i>Connect Live
                    </button>
                </div>
            </div>
        `;
        dronesList.appendChild(droneItem);
    });
}

window.connectToDrone = function(droneId, droneName, droneModel, ipAddress) {
    const discoveredPhase = document.getElementById('discoveredDronesPhase');
    const connectionPhase = document.getElementById('connectionPhase');
    const progressBar = document.querySelector('#connectionProgress .progress-bar');
    const stepsContainer = document.getElementById('connectionSteps');
    
    discoveredPhase.style.display = 'none';
    connectionPhase.style.display = 'block';
    
    selectedDroneInfo = { droneId, droneName, droneModel, ipAddress };
    
    // Show live connection attempt
    stepsContainer.innerHTML = '<div class="alert alert-info"><i class="fas fa-satellite-dish me-2"></i>Establishing live MAVLink connection to Pixhawk...</div>';
    progressBar.style.width = '10%';
    
    fetch('{{ url_for("admin.connect_wireless_drone") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            drone_id: droneId,
            drone_name: droneName,
            drone_model: droneModel,
            ip_address: ipAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentConnectionId = data.connection_id;
            simulateConnectionProgress(data.steps);
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Live connection established to Pixhawk', 'success');
            }
        } else {
            stepsContainer.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Live connection failed: ${data.error}</div>`;
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Live connection failed: ' + data.error, 'error');
            }
            setTimeout(resetConnectionModal, 3000);
        }
    })
    .catch(error => {
        stepsContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Network error during live connection</div>';
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during live connection', 'error');
        }
        setTimeout(resetConnectionModal, 3000);
    });
};

window.simulateConnectionProgress = function(steps) {
    const progressBar = document.querySelector('#connectionProgress .progress-bar');
    const stepsDiv = document.getElementById('connectionSteps');
    let currentStep = 0;
    
    function processNextStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            progressBar.style.width = step.progress + '%';
            
            stepsDiv.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check text-success me-2"></i>
                    <span>${step.message}</span>
                </div>
            `;
            
            currentStep++;
            setTimeout(processNextStep, 1000);
        } else {
            showRegistrationPhase();
        }
    }
    
    processNextStep();
}

function showRegistrationPhase() {
    const connectionPhase = document.getElementById('connectionPhase');
    const registrationPhase = document.getElementById('registrationPhase');
    const registerBtn = document.getElementById('registerDroneBtn');
    const infoDiv = document.getElementById('droneRegistrationInfo');
    
    connectionPhase.style.display = 'none';
    registrationPhase.style.display = 'block';
    registerBtn.style.display = 'inline-block';
    
    infoDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-helicopter me-2"></i>${selectedDroneInfo.droneName}
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Model:</strong> ${selectedDroneInfo.droneModel}</p>
                        <p class="mb-1"><strong>ID:</strong> ${selectedDroneInfo.droneId}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>IP Address:</strong> ${selectedDroneInfo.ipAddress}</p>
                        <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">Connected</span></p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function registerConnectedDrone() {
    if (!currentConnectionId || !selectedDroneInfo) {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('No active connection to register', 'error');
        }
        return;
    }
    
    fetch('{{ url_for("admin.register_wireless_drone") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            drone_id: selectedDroneInfo.droneId,
            drone_name: selectedDroneInfo.droneName,
            drone_model: selectedDroneInfo.droneModel,
            ip_address: selectedDroneInfo.ipAddress,
            connection_id: currentConnectionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification(data.message, 'success');
            }
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('wirelessDroneModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Registration failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during registration', 'error');
        }
    });
}

window.resetConnectionModal = function() {
    document.getElementById('scanPhase').style.display = 'block';
    document.getElementById('discoveredDronesPhase').style.display = 'none';
    document.getElementById('connectionPhase').style.display = 'none';
    document.getElementById('registrationPhase').style.display = 'none';
    document.getElementById('registerDroneBtn').style.display = 'none';
    
    currentConnectionId = null;
    selectedDroneInfo = null;
};

window.checkWirelessStatus = function() {
    const modal = new bootstrap.Modal(document.getElementById('networkStatusModal'));
    modal.show();
    
    const contentDiv = document.getElementById('networkStatusContent');
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Checking live drone network status...</p>
        </div>
    `;
    
    fetch('{{ url_for("admin.wireless_status") }}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNetworkStatus(data);
        } else {
            contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Failed to get live network status</div>';
        }
    })
    .catch(error => {
        contentDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Network error while checking live status</div>';
    });
};

window.displayNetworkStatus = function(data) {
    const content = document.getElementById('networkStatusContent');
    
    let statusHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card bg-primary">
                    <div class="stat-content text-center">
                        <h3>${data.total_drones}</h3>
                        <p>Total Drones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-success">
                    <div class="stat-content text-center">
                        <h3>${data.online_drones}</h3>
                        <p>Live Connected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-warning">
                    <div class="stat-content text-center">
                        <h3>${data.total_drones - data.online_drones}</h3>
                        <p>Offline</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Drone</th>
                        <th>Status</th>
                        <th>Signal</th>
                        <th>Battery</th>
                        <th>MAVLink Rate</th>
                        <th>Last Heartbeat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.drones.forEach(drone => {
        const signalColor = drone.signal_strength > 80 ? 'success' : 
                           drone.signal_strength > 60 ? 'warning' : 'danger';
        const statusColor = drone.connection_quality === 'excellent' ? 'success' : 
                           drone.connection_quality === 'good' ? 'warning' : 'danger';
        
        statusHtml += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-helicopter text-${getStatusColor(drone.status)} me-2"></i>
                        <div>
                            <strong>${drone.name}</strong>
                            <br><small class="text-muted">${drone.model}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${statusColor}">
                        ${drone.connection_quality === 'excellent' ? 'LIVE' : 
                          drone.connection_quality === 'good' ? 'WEAK' : 'OFFLINE'}
                    </span>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-${signalColor}" style="width: ${drone.signal_strength}%"></div>
                        </div>
                        <small>${drone.signal_strength}%</small>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${drone.battery_level}%"></div>
                        </div>
                        <small>${drone.battery_level}%</small>
                    </div>
                </td>
                <td><small>${drone.data_rate}</small></td>
                <td><small>${new Date(drone.last_seen).toLocaleString()}</small></td>
            </tr>
        `;
    });
    
    statusHtml += `
                </tbody>
            </table>
        </div>
        <div class="text-end">
            <small class="text-muted">Last updated: ${new Date(data.last_updated).toLocaleString()}</small>
        </div>
    `;
    
    content.innerHTML = statusHtml + `
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            Live status shows real-time MAVLink connections to Pixhawk flight controllers. 
            Data rates indicate telemetry stream quality from actual aircraft.
        </div>
    `;
}

window.testDroneConnection = function(droneId) {
    fetch(`{{ url_for("admin.test_drone_connection", drone_id=0) }}`.replace('0', droneId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayConnectionTestResults(data);
        } else {
            if (window.showSierraWingsNotification) {
                showSierraWingsNotification('Connection test failed: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        if (window.showSierraWingsNotification) {
            showSierraWingsNotification('Network error during connection test', 'error');
        }
    });
}

window.displayConnectionTestResults = function(data) {
    const modal = new bootstrap.Modal(document.getElementById('connectionTestModal'));
    const content = document.getElementById('testResultsContent');
    
    let resultsHtml = `
        <div class="alert alert-success">
            <h6><i class="fas fa-wifi me-2"></i>Connection Test - ${data.drone_name}</h6>
            <small>Tested at: ${new Date(data.tested_at).toLocaleString()}</small>
        </div>
        
        <div class="list-group">
    `;
    
    Object.entries(data.test_results).forEach(([test, result]) => {
        const icon = result.status === 'success' ? 'fa-check text-success' : 'fa-times text-danger';
        const testName = test.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        resultsHtml += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas ${icon} me-2"></i>
                    <strong>${testName}</strong>
                </div>
                <div class="text-end">
                    ${Object.entries(result).filter(([k,v]) => k !== 'status').map(([k,v]) => 
                        `<small class="text-muted">${v}</small>`
                    ).join('<br>')}
                </div>
            </div>
        `;
    });
    
    resultsHtml += '</div>';
    content.innerHTML = resultsHtml;
    modal.show();
}

// Reset modal when closed
document.getElementById('wirelessDroneModal').addEventListener('hidden.bs.modal', function () {
    resetConnectionModal();
});

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}
