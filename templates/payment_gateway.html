{% extends "base.html" %}

{% block title %}Secure Payment - SierraWings{% endblock %}

{% block head %}
<style>
.payment-container {
    max-width: 600px;
    margin: 0 auto;
}

.payment-method {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.payment-method.selected {
    border-color: #007bff;
    background: #f8f9ff;
}

.payment-method-icon {
    width: 60px;
    height: 40px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-right: 15px;
}

.africanmoney-icon { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40"><rect fill="%2300b04f" width="60" height="40" rx="4"/><text x="30" y="25" text-anchor="middle" fill="white" font-size="10" font-weight="bold">AFRI</text></svg>'); }
.orangemoney-icon { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40"><rect fill="%23ff6600" width="60" height="40" rx="4"/><text x="30" y="25" text-anchor="middle" fill="white" font-size="9" font-weight="bold">ORANGE</text></svg>'); }
.qmoney-icon { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40"><rect fill="%236c5ce7" width="60" height="40" rx="4"/><text x="30" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Q</text></svg>'); }
.card-icon { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40"><rect fill="%232c3e50" width="60" height="40" rx="4"/><rect fill="%23f39c12" x="5" y="15" width="50" height="8"/><text x="30" y="32" text-anchor="middle" fill="white" font-size="8">CARD</text></svg>'); }

.security-badges {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
}

.security-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    background: #f8f9fa;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #6c757d;
}

.form-floating {
    position: relative;
}

.payment-form {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
}

.mobile-money-form, .card-form {
    display: none;
}

.mobile-money-form.active, .card-form.active {
    display: block;
}

.phone-input {
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="%236c757d"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>') no-repeat 15px center;
    background-size: 20px;
    padding-left: 45px;
}

.card-number-input {
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="%236c757d"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>') no-repeat 15px center;
    background-size: 20px;
    padding-left: 45px;
}

.amount-display {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 25px;
}

.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.processing-content {
    background: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="payment-container">
        <div class="text-center mb-4">
            <h2 class="text-primary mb-2">
                <i class="fas fa-shield-alt me-2"></i>Secure Payment Gateway
            </h2>
            <p class="text-muted">Complete your payment securely for Mission #{{ mission_id }}</p>
        </div>

        <!-- Amount Display -->
        <div class="amount-display">
            <h3 class="mb-1">Total Amount</h3>
            <h1 class="mb-0">Le {{ "{:,.2f}".format(amount) }}</h1>
            <small>Delivery fee included</small>
        </div>

        <!-- Security Badges -->
        <div class="security-badges">
            <div class="security-badge">
                <i class="fas fa-lock text-success"></i>
                <span>256-bit SSL</span>
            </div>
            <div class="security-badge">
                <i class="fas fa-shield-alt text-primary"></i>
                <span>PCI Compliant</span>
            </div>
            <div class="security-badge">
                <i class="fas fa-check-circle text-success"></i>
                <span>Verified Secure</span>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="payment-methods mb-4">
            <h5 class="mb-3">Choose Payment Method</h5>
            
            <!-- Afri Money -->
            <div class="payment-method" data-method="africanmoney" onclick="selectPaymentMethod('africanmoney')">
                <div class="d-flex align-items-center">
                    <div class="payment-method-icon africanmoney-icon"></div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Afri Money</h6>
                        <p class="text-muted small mb-0">Pay with your Afri Money wallet</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="africanmoney">
                    </div>
                </div>
            </div>

            <!-- Orange Money -->
            <div class="payment-method" data-method="orangemoney" onclick="selectPaymentMethod('orangemoney')">
                <div class="d-flex align-items-center">
                    <div class="payment-method-icon orangemoney-icon"></div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Orange Money</h6>
                        <p class="text-muted small mb-0">Pay with your Orange Money account</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="orangemoney">
                    </div>
                </div>
            </div>

            <!-- Q-Money -->
            <div class="payment-method" data-method="qmoney" onclick="selectPaymentMethod('qmoney')">
                <div class="d-flex align-items-center">
                    <div class="payment-method-icon qmoney-icon"></div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Q-Money</h6>
                        <p class="text-muted small mb-0">Pay with your Q-Money wallet</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="qmoney">
                    </div>
                </div>
            </div>

            <!-- Bank Card -->
            <div class="payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                <div class="d-flex align-items-center">
                    <div class="payment-method-icon card-icon"></div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Bank Card</h6>
                        <p class="text-muted small mb-0">Visa, Mastercard, or local bank cards</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="card">
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Forms -->
        <div class="payment-form" id="paymentForm" style="display: none;">
            
            <!-- Mobile Money Form -->
            <div class="mobile-money-form" id="mobileMoneyForm">
                <h5 class="mb-3">
                    <i class="fas fa-mobile-alt me-2"></i>Mobile Money Payment
                </h5>
                
                <form id="mobilePaymentForm" onsubmit="processMobilePayment(event)">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <div class="form-floating">
                                <input type="tel" class="form-control phone-input" id="phoneNumber" 
                                       placeholder="Phone Number" required pattern="[0-9]{8,12}">
                                <label for="phoneNumber">Phone Number</label>
                            </div>
                            <div class="form-text">Enter your mobile money registered number</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="phonePrefix" required>
                                    <option value="+232">+232 (SL)</option>
                                    <option value="+224">+224 (GN)</option>
                                    <option value="+225">+225 (CI)</option>
                                </select>
                                <label for="phonePrefix">Country</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-floating">
                            <input type="password" class="form-control" id="mobilePIN" 
                                   placeholder="PIN" required minlength="4" maxlength="6">
                            <label for="mobilePIN">Mobile Money PIN</label>
                        </div>
                        <div class="form-text">Your mobile money transaction PIN</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-mobile-alt me-2"></i>Pay Le {{ "{:,.2f}".format(amount) }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>Choose Different Method
                        </button>
                    </div>
                </form>
            </div>

            <!-- Card Payment Form -->
            <div class="card-form" id="cardForm">
                <h5 class="mb-3">
                    <i class="fas fa-credit-card me-2"></i>Card Payment
                </h5>
                
                <form id="cardPaymentForm" onsubmit="processCardPayment(event)">
                    <div class="mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control card-number-input" id="cardNumber" 
                                   placeholder="Card Number" required pattern="[0-9\s]{13,19}" 
                                   maxlength="19" autocomplete="cc-number">
                            <label for="cardNumber">Card Number</label>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="cardName" 
                                       placeholder="Cardholder Name" required autocomplete="cc-name">
                                <label for="cardName">Cardholder Name</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="cardCVV" 
                                       placeholder="CVV" required pattern="[0-9]{3,4}" 
                                       maxlength="4" autocomplete="cc-csc">
                                <label for="cardCVV">CVV</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="form-floating">
                                <select class="form-select" id="cardMonth" required autocomplete="cc-exp-month">
                                    <option value="">Month</option>
                                    {% for i in range(1, 13) %}
                                    <option value="{{ '%02d'|format(i) }}">{{ '%02d'|format(i) }}</option>
                                    {% endfor %}
                                </select>
                                <label for="cardMonth">Expiry Month</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <select class="form-select" id="cardYear" required autocomplete="cc-exp-year">
                                    <option value="">Year</option>
                                    {% for year in range(2025, 2036) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                                <label for="cardYear">Expiry Year</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-lock me-2"></i>Pay Securely Le {{ "{:,.2f}".format(amount) }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>Choose Different Method
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="processingOverlay">
    <div class="processing-content">
        <div class="spinner"></div>
        <h4>Processing Payment...</h4>
        <p class="text-muted">Please wait while we securely process your payment.</p>
        <small class="text-warning">
            <i class="fas fa-exclamation-triangle me-1"></i>
            Do not close this window or refresh the page
        </small>
    </div>
</div>

<script>
let selectedMethod = null;

function selectPaymentMethod(method) {
    // Remove previous selections
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('input[type="radio"]').checked = false;
    });
    
    // Select new method
    const selectedElement = document.querySelector(`[data-method="${method}"]`);
    selectedElement.classList.add('selected');
    selectedElement.querySelector('input[type="radio"]').checked = true;
    
    selectedMethod = method;
    showPaymentForm(method);
}

function showPaymentForm(method) {
    const paymentForm = document.getElementById('paymentForm');
    const mobileForm = document.getElementById('mobileMoneyForm');
    const cardForm = document.getElementById('cardForm');
    
    // Hide all forms first
    mobileForm.classList.remove('active');
    cardForm.classList.remove('active');
    
    // Show appropriate form
    if (method === 'card') {
        cardForm.classList.add('active');
    } else {
        mobileForm.classList.add('active');
    }
    
    paymentForm.style.display = 'block';
    paymentForm.scrollIntoView({ behavior: 'smooth' });
}

function goBack() {
    document.getElementById('paymentForm').style.display = 'none';
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('input[type="radio"]').checked = false;
    });
    selectedMethod = null;
}

function processMobilePayment(event) {
    event.preventDefault();
    
    const phonePrefix = document.getElementById('phonePrefix').value;
    const phoneNumber = document.getElementById('phoneNumber').value;
    const pin = document.getElementById('mobilePIN').value;
    
    if (!phoneNumber || !pin) {
        alert('Please fill in all required fields.');
        return;
    }
    
    showProcessingOverlay();
    
    // Simulate secure payment processing
    const paymentData = {
        method: selectedMethod,
        phone: phonePrefix + phoneNumber,
        pin: pin,
        amount: {{ amount }},
        mission_id: {{ mission_id }},
        timestamp: new Date().toISOString()
    };
    
    // Send encrypted payment request
    fetch('/api/payment/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingOverlay();
        if (data.success) {
            showPaymentSuccess(data.transaction_id);
        } else {
            showPaymentError(data.message);
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        showPaymentError('Payment processing failed. Please try again.');
    });
}

function processCardPayment(event) {
    event.preventDefault();
    
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const cardName = document.getElementById('cardName').value;
    const cardMonth = document.getElementById('cardMonth').value;
    const cardYear = document.getElementById('cardYear').value;
    const cardCVV = document.getElementById('cardCVV').value;
    
    if (!cardNumber || !cardName || !cardMonth || !cardYear || !cardCVV) {
        alert('Please fill in all card details.');
        return;
    }
    
    showProcessingOverlay();
    
    // Tokenize card data for security
    const paymentData = {
        method: 'card',
        card_token: btoa(cardNumber).slice(0, 16), // Simplified tokenization
        cardholder: cardName,
        amount: {{ amount }},
        mission_id: {{ mission_id }},
        timestamp: new Date().toISOString()
    };
    
    // Send secure payment request
    fetch('/api/payment/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingOverlay();
        if (data.success) {
            showPaymentSuccess(data.transaction_id);
        } else {
            showPaymentError(data.message);
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        showPaymentError('Payment processing failed. Please try again.');
    });
}

function showProcessingOverlay() {
    document.getElementById('processingOverlay').style.display = 'flex';
}

function hideProcessingOverlay() {
    document.getElementById('processingOverlay').style.display = 'none';
}

function showPaymentSuccess(transactionId) {
    alert(`Payment successful! Transaction ID: ${transactionId}`);
    window.location.href = '/patient/track-mission?mission_id={{ mission_id }}';
}

function showPaymentError(message) {
    alert(`Payment failed: ${message}`);
}

// Format card number input
document.getElementById('cardNumber').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
});

// Format phone number input
document.getElementById('phoneNumber').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
});

// Security: Clear sensitive data on page unload
window.addEventListener('beforeunload', function() {
    document.getElementById('mobilePIN').value = '';
    document.getElementById('cardNumber').value = '';
    document.getElementById('cardCVV').value = '';
});
</script>
{% endblock %}